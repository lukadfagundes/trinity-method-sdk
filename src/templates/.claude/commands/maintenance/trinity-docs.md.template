# Trinity Documentation Generator (Orchestration Architecture)

**Command:** `/execution:trinity-docs`
**Purpose:** Generate comprehensive project documentation using multi-agent orchestration
**Architecture:** JUNO audit ‚Üí Parallel APO execution ‚Üí Verification
**Trinity Version:** 2.1.0
**Last Updated:** 2026-01-21

---

## Overview

This command uses **agent orchestration** to generate documentation:

1. **JUNO** audits codebase and creates documentation checklist report
2. **Three APO instances** execute in parallel, each handling one section:
   - APO-1: Architecture diagrams
   - APO-2: API documentation and guides
   - APO-3: Configuration files
3. **Verification** ensures all items from checklist were completed

**Key Benefits:**
- Each agent has clean, focused context (<100 lines of instructions)
- Parallel execution (3x faster)
- Quality gate upfront (JUNO validates before generation)
- No single agent reads massive command (prevents context fatigue)

---

## Phase 0: Preparation

Before invoking agents, set up the environment:

```javascript
// Global state tracking
global.trinity_docs_session = {
  started: new Date().toISOString(),
  audit_report: null,
  juno_incomplete: false,
  juno_issues: [],
  apo_results: {
    diagrams: null,
    docs: null,
    config: null
  },
  verification: null,
  performance_metrics: {
    juno_start: null,
    juno_end: null,
    apo_start: null,
    apo_end: null,
    verification_start: null,
    verification_end: null,
    total_start: Date.now(),
    total_end: null
  }
};

LOG: "";
LOG: "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó";
LOG: "‚ïë     TRINITY DOCUMENTATION GENERATOR v2.0.9                 ‚ïë";
LOG: "‚ïë     Architecture: Multi-Agent Orchestration                ‚ïë";
LOG: "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù";
LOG: "";
LOG: "üìã Documentation generation process:";
LOG: "   1. JUNO audits codebase (READ-ONLY)";
LOG: "   2. Three APO instances generate docs (PARALLEL)";
LOG: "   3. Verification ensures completeness and quality";
LOG: "";
```

---

## Phase 0.2: Template Validation (Rec 18 - Optional)

**Purpose:** Validate template files before APO execution (optional quality check)

```javascript
// Optional: Enable template validation (default: disabled for performance)
const VALIDATE_TEMPLATES = false; // Set to true to enable template validation

if (VALIDATE_TEMPLATES) {
  LOG: "";
  LOG: "=== PHASE 0.2: TEMPLATE VALIDATION ===";
  LOG: "";
  LOG: "Validating template files for correct variable syntax...";
  LOG: "";

  // Template paths - See trinity/templates/documentation/configuration/documentation-structure.md
  const template_base = "trinity/templates/documentation";
  const template_paths = [
    `${template_base}/mermaid-diagrams/*.md`,
    `${template_base}/guides/*.md`,
    `${template_base}/api/README.md`,
    `${template_base}/configuration/*.md`
  ];

  const template_issues = [];
  let templates_validated = 0;
  let templates_skipped = 0;

  for (const path of template_paths) {
    if (!exists(path)) {
      templates_skipped++;
      LOG: \`  ‚è≠Ô∏è Skipped: \${path} (not found)\`;
      continue;
    }

    const content = Read(path);
    templates_validated++;

    // Check 1: Valid variable syntax (only {{UPPERCASE_UNDERSCORE}})
    const variable_pattern = /\{\{([^}]+)\}\}/g;
    const variables = content.match(variable_pattern);

    if (variables) {
      for (const variable of variables) {
        const var_name = variable.replace(/[{}]/g, '');

        // Valid: {{DATABASE_TYPE}}, {{API_BASE_PATH}}
        // Invalid: {{databaseType}}, {{Database Type}}, {{123}}
        if (!/^[A-Z][A-Z0-9_]*$/.test(var_name)) {
          template_issues.push({
            file: path,
            variable: variable,
            reason: "Invalid variable name (must be UPPERCASE_UNDERSCORE)"
          });
        }
      }
    }

    // Check 2: Ensure no nested variables ({{VAR_{{NESTED}}}})
    if (/\{\{[^}]*\{\{/.test(content)) {
      template_issues.push({
        file: path,
        variable: "N/A",
        reason: "Nested variables detected (not supported)"
      });
    }

    // Check 3: Balanced braces
    const open_braces = (content.match(/\{\{/g) || []).length;
    const close_braces = (content.match(/\}\}/g) || []).length;

    if (open_braces !== close_braces) {
      template_issues.push({
        file: path,
        variable: "N/A",
        reason: \`Unbalanced braces (\${open_braces} open, \${close_braces} close)\`
      });
    }

    if (template_issues.filter(i => i.file === path).length === 0) {
      LOG: \`  ‚úÖ Valid: \${path}\`;
    } else {
      WARNING: \`  ‚ö†Ô∏è Issues: \${path}\`;
    }
  }

  LOG: "";
  LOG: \`Template Validation Summary:\`;
  LOG: \`  Validated: \${templates_validated}\`;
  LOG: \`  Skipped: \${templates_skipped} (not found)\`;
  LOG: \`  Issues: \${template_issues.length}\`;
  LOG: "";

  if (template_issues.length > 0) {
    WARNING: "";
    WARNING: "‚ö†Ô∏è Template validation warnings (non-blocking):";
    for (const issue of template_issues) {
      WARNING: \`   \${issue.file}\`;
      WARNING: \`     Variable: \${issue.variable}\`;
      WARNING: \`     Issue: \${issue.reason}\`;
    }
    WARNING: "";
    WARNING: "These issues may cause APO variable replacement failures.";
    WARNING: "Consider fixing templates before production use.";
    WARNING: "";
  } else if (templates_validated > 0) {
    LOG: "‚úÖ All templates have valid syntax";
    LOG: "";
  }
}
```

---

## Phase 0.25: Retry Mechanism (Rec 21)

**Purpose:** Handle transient failures gracefully (filesystem delays, race conditions)

```javascript
// Rec 21: Retry mechanism for operations that may have transient failures
function retry_operation(operation_name, operation_func, max_attempts = 3, delay_ms = 500) {
  LOG: `Executing: ${operation_name} (max ${max_attempts} attempts)`;

  for (let attempt = 1; attempt <= max_attempts; attempt++) {
    try {
      LOG: `  Attempt ${attempt}/${max_attempts}...`;

      const result = operation_func();

      LOG: `  ‚úÖ ${operation_name} succeeded on attempt ${attempt}`;
      return {
        success: true,
        result: result,
        attempts: attempt
      };
    } catch (error) {
      if (attempt < max_attempts) {
        WARNING: `  ‚ö†Ô∏è Attempt ${attempt} failed: ${error.message}`;
        WARNING: `  Retrying in ${delay_ms}ms...`;

        // Wait before retry
        const start = Date.now();
        while (Date.now() - start < delay_ms) {
          // Busy wait
        }
      } else {
        // Final attempt failed
        ERROR: `  ‚ùå ${operation_name} failed after ${max_attempts} attempts`;
        ERROR: `  Final error: ${error.message}`;

        return {
          success: false,
          error: error,
          attempts: attempt
        };
      }
    }
  }
}

// Example usage patterns:

// Pattern 1: File read with retry (handles filesystem delays)
const file_read_result = retry_operation(
  "Read JUNO report",
  () => Read("trinity/reports/DOCS-AUDIT-*.md"),
  3,
  500
);

if (!file_read_result.success) {
  ERROR: "Failed to read JUNO report after retries";
  ABORT_COMMAND();
}

const audit_report_content = file_read_result.result;

// Pattern 2: Glob with retry (handles race conditions in parallel execution)
const file_discovery_result = retry_operation(
  "Discover documentation files",
  () => {
    const files = {
      diagrams: Glob({pattern: "docs/images/*.md"}),
      guides: Glob({pattern: "docs/guides/*.md"}),
      api: Glob({pattern: "docs/api/*.md"})
    };

    const total = files.diagrams.length + files.guides.length + files.api.length;

    if (total === 0) {
      throw new Error("No files discovered - may be transient filesystem delay");
    }

    return files;
  },
  3,
  1000 // Longer delay for file discovery
);

if (!file_discovery_result.success) {
  ERROR: "Failed to discover files after retries - generation likely failed";
  ABORT_COMMAND();
}

// Pattern 3: File existence check with retry
const file_exists_result = retry_operation(
  "Check file existence",
  () => {
    if (!exists("expected/file/path.md")) {
      throw new Error("File not found");
    }
    return true;
  },
  3,
  500
);
```

**When to Use Retry Mechanism:**

1. **File Operations After Parallel Execution:**
   - Reading files created by parallel APO instances
   - Glob operations immediately after APO completion
   - File existence checks in verification phase

2. **Transient Error Indicators:**
   - "File not found" (immediately after known file creation)
   - Empty Glob results (when files should exist)
   - "Permission denied" (temporary lock)
   - "Resource temporarily unavailable"

3. **DO NOT Use For:**
   - Permanent errors (syntax errors, logic errors)
   - User input errors
   - Configuration errors
   - Business logic failures

**Integration Points:**

- Phase 1: Reading JUNO report after generation
- Phase 2: APO synchronization barrier (file availability check)
- Phase 2: APO-3 README link validation (file existence)
- Phase 3: Verification file discovery
- Phase 3: Reading generated files for quality checks

---

## Phase 0.5: Success Criteria Definition

**Purpose:** Define objective quality standards for documentation generation

### Tier 1: Completion (REQUIRED - 40 points)

**File Creation:**
- All expected files created (based on JUNO report)
- Correct directory structure (docs/images/, docs/guides/, docs/api/)
- No missing files from checklist

**Threshold:** 100% completion required (0 points if any file missing)

### Tier 2: Content Quality (REQUIRED - 40 points)

**Template Placeholders (10 points):**
- ABORT: Any {{VARIABLE}} syntax remaining in output files
- Expected: 0 placeholders in all documentation

**Internal Link Validation (15 points):**
- ABORT: Any broken internal links (file references that don't exist)
- Expected: 0 broken links in all documentation

**Mermaid Syntax Validation (15 points):**
- ABORT: Invalid Mermaid syntax in diagram files
- Expected: All diagrams have valid Mermaid code blocks with proper diagram types

**Threshold:** Must pass all checks (100%) - any failure causes ABORT

### Tier 3: Content Accuracy (WARNING - 15 points)

**Documentation vs. Reality (15 points):**
- WARN: API endpoint counts differ by >¬±1
- WARN: Component counts differ by >¬±2
- WARN: Testing framework mentioned incorrectly (e.g., Jest when using Vitest)
- WARN: Non-existent components referenced in diagrams

**Threshold:** Warnings logged but do not cause ABORT

### Tier 4: Excellence (OPTIONAL - 5 points)

**Best Practices:**
- Comprehensive code examples in guides
- Clear architecture explanations
- Helpful deployment instructions
- Complete API documentation with examples

### Scoring Formula

```
Total Score = Tier1_Points + Tier2_Points + Tier3_Points + Tier4_Points

Grade Scale:
- 95-100: Excellent (Production Ready)
- 85-94: Good (Minor improvements recommended)
- 70-84: Acceptable (Requires review and fixes)
- <70: Poor (Significant issues, re-generation recommended)
```

**Quality Gates:**
- Tier 1 failure: ABORT immediately
- Tier 2 failure: ABORT immediately
- Tier 3 issues: LOG warnings, continue
- Tier 4 issues: LOG suggestions, continue

---

## Phase 1: JUNO Documentation Audit

**Purpose:** Analyze codebase and create comprehensive documentation checklist

### Step 1.1: Invoke JUNO for Codebase Audit

```javascript
// ============================================================
// PHASE 0: TEMPLATE VALIDATION (PRE-EXECUTION GATE)
// WO-003: Pre-execution gate ensures all required templates exist
// ============================================================

LOG: "";
LOG: "=== PHASE 0: TEMPLATE VALIDATION ===";
LOG: "Verifying all required templates exist before execution...";
LOG: "";

const required_templates = [
  // Mermaid diagrams (WO-1.8) - deployed without .template suffix
  "trinity/templates/documentation/mermaid-diagrams/mvc-flow.md",
  "trinity/templates/documentation/mermaid-diagrams/database-er.md",
  "trinity/templates/documentation/mermaid-diagrams/api-endpoint-map.md",
  "trinity/templates/documentation/mermaid-diagrams/component-hierarchy.md",

  // Guides (WO-002) - deployed without .template suffix
  "trinity/templates/documentation/guides/getting-started.md",
  "trinity/templates/documentation/guides/api-development.md",
  "trinity/templates/documentation/guides/deployment.md",
  "trinity/templates/documentation/guides/contributing.md",

  // API docs (WO-002) - deployed without .template suffix
  "trinity/templates/documentation/api-docs/README.md",

  // Configuration (WO-003) - deployed without .template suffix
  "trinity/templates/documentation/configuration/env-example-generator.md",

  // JUNO internal report (WO-1.8) - deployed without .template suffix
  "trinity/templates/documentation/reports/juno-internal-report.md"
];

const missing_templates = [];

for (const template_path of required_templates) {
  // Check if template file exists
  if (!exists(template_path)) {
    missing_templates.push(template_path);
    ERROR: \`‚ùå Missing required template: \${template_path}\`;
  } else {
    LOG: \`  ‚úÖ \${template_path}\`;
  }
}

if (missing_templates.length > 0) {
  ERROR: "";
  ERROR: "‚ùå CRITICAL ERROR: Required templates missing";
  ERROR: \`Missing \${missing_templates.length} template file(s)\`;
  ERROR: "";
  ERROR: "This indicates 'trinity update' CLI was not run or templates failed to deploy.";
  ERROR: "";
  ERROR: "REQUIRED ACTIONS:";
  ERROR: "  1. Run: trinity update";
  ERROR: "  2. Verify templates exist in trinity/templates/documentation/";
  ERROR: "  3. Re-run this command";
  ERROR: "";

  // ABORT - Cannot proceed without templates
  return {
    status: "ABORTED",
    reason: "Required templates missing",
    missing_templates: missing_templates,
    action_required: "Run 'trinity update' to deploy templates"
  };
}

LOG: "";
LOG: \`‚úÖ Template validation PASSED: All \${required_templates.length} templates found\`;
LOG: "";
LOG: "=== PHASE 0 COMPLETE ===";
LOG: "";

LOG: "=== PHASE 1: JUNO DOCUMENTATION AUDIT ===";
LOG: "";
LOG: "Invoking JUNO (Quality Auditor) to analyze codebase...";
LOG: "";

// Track performance
global.trinity_docs_session.performance_metrics.juno_start = Date.now();

// Invoke JUNO agent
Task({
  subagent_type: "JUNO (Quality Auditor)",
  description: "Audit codebase for documentation needs",
  prompt: `
# JUNO Documentation Audit Task

**Objective:** Analyze the codebase and create a comprehensive documentation checklist report using the internal report template.

## Your Mission

You are JUNO, the Quality Auditor. Your task is to audit this codebase and generate a structured report for APO consumption.

**CRITICAL:** This is a READ-ONLY operation. DO NOT create any documentation files. Only analyze and create the audit report.

---

## Report Template to Use

**Template File:** \`trinity/templates/documentation/reports/juno-internal-report.md\`

**Instructions:**
1. **Read the template** to understand the complete structure required
2. **Analyze the codebase** to gather all data for every {{VARIABLE}}
3. **Replace ALL placeholders** with actual discovered values (no placeholders like "[Database detected]")
4. **Output the completed report** to: \`trinity/reports/DOCS-AUDIT-{timestamp}.md\`

**Timestamp Format:** YYYY-MM-DD-HHmm (e.g., 2026-01-15-1530)

---

## Critical Requirements

**ZERO TOLERANCE RULES:**
- ALL {{VARIABLE}} placeholders MUST be replaced with actual values
- Component names MUST exist in codebase (verify with Glob)
- Model names MUST come from actual schema files
- Endpoint counts MUST match actual route files
- Testing framework MUST be from package.json (not assumed)
- Use ONLY discovered data - NO invented names, NO assumptions

**Autonomous Execution:**
- Do NOT ask user for input
- Do NOT prompt for decisions
- Proceed directly to analyze and generate report
- If ambiguous: use sensible defaults based on codebase evidence

---

## Discovery Logic

**Use discovery templates for codebase analysis:**

- **Framework Detection:** See `trinity/templates/documentation/discovery/framework-detection.md` for package.json analysis patterns
- **Component Discovery:** See `trinity/templates/documentation/discovery/component-discovery.md` for React/Vue/Angular/Svelte component patterns (CRITICAL: Zero tolerance for fake components)
- **API Endpoints:** See `trinity/templates/documentation/discovery/api-endpoint-scanner.md` for Express/Fastify/NestJS/Koa route patterns
- **Environment Variables:** See `trinity/templates/documentation/discovery/env-variable-extraction.md` for .env and process.env usage patterns

**Database Schema Analysis:**
- Prisma: Parse `prisma/schema.prisma` for models and relationships
- TypeORM: Find `@Entity` decorator files
- Mongoose: Find schema definitions

---

## Template Usage Instructions

**Read the template first:**
\`\`\`javascript
const template_content = Read("trinity/templates/documentation/reports/juno-internal-report.md");
// Study the structure to understand ALL {{VARIABLES}} you need to fill
\`\`\`

**Perform all discovery tasks above, then fill the template:**
- Replace {{PROJECT_NAME}} with actual name from package.json
- Replace {{BACKEND_FRAMEWORK}} with detected framework
- Replace {{MODEL_COUNT}} with actual count from schema
- Replace {{ENDPOINT_COUNT}} with actual discovered count
- Replace {{COMPONENT_NAMES}} with comma-separated list of actual components
- **ALL {{VARIABLES}} must be replaced - zero tolerance for placeholders**

**Output the completed report:**
\`\`\`javascript
const completed_report = /* filled template with all variables replaced */;
Write("trinity/reports/DOCS-AUDIT-{timestamp}.md", completed_report);
\`\`\`

---

## Self-Validation (Rec 3)

Before returning, verify report completeness:

\`\`\`javascript
const report_path = "trinity/reports/DOCS-AUDIT-{timestamp}.md";
const report_content = Read(report_path);

const validation_checks = {
  file_exists: report_content.length > 0,
  has_all_sections: report_content.includes("SECTION A") &&
                    report_content.includes("SECTION B") &&
                    report_content.includes("SECTION C"),
  min_length: report_content.length >= 2000,
  no_placeholders: !report_content.includes("[") && !report_content.includes("{{"),
  component_verification: /* Glob each listed component path to verify exists */
};

// All checks must pass before proceeding
if (!Object.values(validation_checks).every(v => v === true)) {
  ERROR: "JUNO self-validation failed - fix report before returning";
  return "VALIDATION_FAILED";
}

LOG: "‚úÖ JUNO self-validation passed";
\`\`\`

---

## Completion Summary

Return concise summary after validation passes:

\`\`\`
JUNO Audit Complete
Report: trinity/reports/DOCS-AUDIT-{timestamp}.md

Architecture: [type]
Backend: [framework] [version]
Frontend: [framework] [version]
Database: [type] ([N] models)
API: [N] endpoints
Components: [N] total
Testing: [framework or None]

Documentation: [N] files to generate
Status: Ready for APO execution
\`\`\`
  `
});

LOG: "";
LOG: "‚è≥ Waiting for JUNO audit to complete...";
LOG: "";
```

### Step 1.2: Capture JUNO's Report Path and Validate (Rec 1)

```javascript
// After JUNO completes, extract report path from response
const juno_response = [JUNO's returned message];

// Track performance
global.trinity_docs_session.performance_metrics.juno_end = Date.now();

// Parse report path from JUNO's response
const report_path_match = juno_response.match(/trinity\/reports\/DOCS-AUDIT-[\d-]+\.md/);

if (!report_path_match) {
  ERROR: "";
  ERROR: "‚ùå CRITICAL ERROR: JUNO did not create audit report";
  ERROR: "Expected report at: trinity/reports/DOCS-AUDIT-{timestamp}.md";
  ERROR: "";
  ERROR: "Cannot proceed without audit report.";
  ERROR: "";
  ABORT_COMMAND();
}

const audit_report_path = report_path_match[0];
global.trinity_docs_session.audit_report = audit_report_path;

LOG: `‚úÖ JUNO audit complete: ${audit_report_path}`;

// NEW: Validate JUNO report completeness (Recommendation 1)
LOG: "";
LOG: "Validating JUNO report completeness...";

const juno_report = Read(audit_report_path);
const juno_issues = [];

// Check 1: Report size (should be substantial)
if (juno_report.length < 1000) {
  juno_issues.push({
    severity: "HIGH",
    issue: `Report suspiciously short (${juno_report.length} chars, expected 2000+)`
  });
}

// Check 2: Required sections present
const has_section_a = juno_report.includes("## SECTION A:");
const has_section_b = juno_report.includes("## SECTION B:");
const has_section_c = juno_report.includes("## SECTION C:");

if (!has_section_a) {
  juno_issues.push({
    severity: "CRITICAL",
    issue: "Section A (Architecture & Diagrams) missing"
  });
}

if (!has_section_b) {
  juno_issues.push({
    severity: "CRITICAL",
    issue: "Section B (API Documentation & Guides) missing"
  });
}

if (!has_section_c) {
  juno_issues.push({
    severity: "CRITICAL",
    issue: "Section C (Configuration & Setup) missing"
  });
}

// Check 3: Executive Summary present
const has_executive_summary = juno_report.includes("## Executive Summary") || juno_report.includes("Executive Summary:");
if (!has_executive_summary) {
  juno_issues.push({
    severity: "HIGH",
    issue: "Executive Summary missing"
  });
}

// Check 4: Enhanced Placeholder Detection (Rec 4)
LOG: "Checking for template placeholders...";

// Rec 4: Multiple placeholder patterns
const placeholder_patterns = [
  /\[[A-Z][a-z]+( [a-z]+)+ detected\]/g,          // [Database type detected]
  /\{\{[A-Z_]+\}\}/g,                             // {{VARIABLE}}
  /\[YOUR_[A-Z_]+\]/g,                            // [YOUR_API_KEY]
  /\bTBD\b/g,                                      // TBD
  /\bTODO:/g,                                      // TODO:
  /\[PLACEHOLDER\]/gi,                             // [PLACEHOLDER]
  /\[Fill this in\]/gi,                            // [Fill this in]
  /\[Add (.*?) here\]/gi                           // [Add X here]
];

const found_placeholders = [];
let total_placeholder_count = 0;

for (const pattern of placeholder_patterns) {
  const matches = juno_report.match(pattern);
  if (matches) {
    total_placeholder_count += matches.length;
    for (const match of matches) {
      if (!found_placeholders.includes(match)) {
        found_placeholders.push(match);
      }
    }
  }
}

LOG: `Placeholder patterns checked: ${placeholder_patterns.length}`;
LOG: `Unique placeholders found: ${found_placeholders.length}`;
LOG: `Total occurrences: ${total_placeholder_count}`;

if (total_placeholder_count > 3) {
  juno_issues.push({
    severity: "HIGH",
    issue: `Too many placeholders detected (${total_placeholder_count} instances): ${found_placeholders.slice(0, 5).join(', ')}${found_placeholders.length > 5 ? '...' : ''}`
  });

  WARNING: `Found ${total_placeholder_count} placeholders in JUNO report:`;
  for (const ph of found_placeholders.slice(0, 10)) {
    WARNING: `  - ${ph}`;
  }
  if (found_placeholders.length > 10) {
    WARNING: `  ... and ${found_placeholders.length - 10} more`;
  }
}

// Check 5: Component Verification (Rec 3) - Verify no invented components
LOG: "";
LOG: "Performing component verification (Rec 3)...";

// Extract component names documented in JUNO report
const component_section = juno_report.match(/\*\*Discovered Components.*?(?=\n\*\*|$)/s);
const documented_components = [];

if (component_section) {
  const component_lines = component_section[0].match(/^\d+\.\s+([A-Za-z0-9_]+)/gm);
  if (component_lines) {
    for (const line of component_lines) {
      const component_name = line.match(/^\d+\.\s+([A-Za-z0-9_]+)/)[1];
      documented_components.push(component_name);
    }
  }
}

LOG: `Documented components in report: ${documented_components.length}`;

// Re-discover components from actual codebase
// See trinity/templates/documentation/configuration/documentation-structure.md for full patterns
const component_patterns = [
  "client/**/*.{tsx,jsx,vue}",
  "src/**/*.{tsx,jsx,vue}"
];

let actual_component_files = [];
for (const pattern of component_patterns) {
  const files = Glob({pattern: pattern});
  actual_component_files = [...actual_component_files, ...files];
}

// Filter out non-component files
const actual_components = actual_component_files.filter(f =>
  !f.includes('.test.') &&
  !f.includes('.spec.') &&
  !f.endsWith('main.tsx') &&
  !f.endsWith('main.jsx') &&
  !f.endsWith('index.tsx') &&
  !f.endsWith('index.jsx') &&
  !f.includes('setupTests') &&
  !f.includes('vite.config') &&
  !f.includes('.config.')
);

// Extract actual component names
const actual_component_names = actual_components.map(f => {
  const path_parts = f.split('/');
  const filename = path_parts[path_parts.length - 1];
  return filename.replace(/\.(tsx|jsx|vue)$/, '');
});

LOG: `Actual components in codebase: ${actual_component_names.length}`;

// Find invented components (in report but not in codebase)
const invented_components = [];
for (const doc_component of documented_components) {
  if (!actual_component_names.includes(doc_component)) {
    invented_components.push(doc_component);
  }
}

if (invented_components.length > 0) {
  juno_issues.push({
    severity: "CRITICAL",
    issue: `Invented components detected (${invented_components.length}): ${invented_components.join(', ')}`
  });

  ERROR: "";
  ERROR: `‚ùå Component verification failed: ${invented_components.length} invented components`;
  for (const invented of invented_components) {
    ERROR: `   - ${invented} (NOT FOUND in codebase)`;
  }
  ERROR: "";
} else {
  LOG: `‚úÖ Component verification passed: All ${documented_components.length} components exist in codebase`;
}

LOG: "";

// Report validation results
LOG: `Report size: ${juno_report.length} characters`;
LOG: `Section A present: ${has_section_a ? "‚úÖ" : "‚ùå"}`;
LOG: `Section B present: ${has_section_b ? "‚úÖ" : "‚ùå"}`;
LOG: `Section C present: ${has_section_c ? "‚úÖ" : "‚ùå"}`;
LOG: `Executive Summary: ${has_executive_summary ? "‚úÖ" : "‚ùå"}`;
LOG: `Placeholders: ${placeholder_count} instances`;
LOG: "";

// Decision: Proceed with warnings or abort?
const critical_issues = juno_issues.filter(i => i.severity === "CRITICAL");

if (critical_issues.length >= 3) {
  // All sections missing - report is too minimal
  ERROR: "";
  ERROR: "‚ùå JUNO REPORT VALIDATION: CRITICAL FAILURE";
  ERROR: "";
  ERROR: "JUNO report is too incomplete to proceed:";
  for (const issue of juno_issues) {
    ERROR: `   [${issue.severity}] ${issue.issue}`;
  }
  ERROR: "";
  ERROR: "The report must contain Executive Summary and all 3 sections (A, B, C).";
  ERROR: "Please investigate JUNO task execution.";
  ERROR: "";
  ABORT_COMMAND();
} else if (juno_issues.length > 0) {
  // Some issues but not critical failure
  WARNING: "";
  WARNING: "‚ö†Ô∏è JUNO REPORT VALIDATION: PARTIAL SUCCESS";
  WARNING: "";
  WARNING: "Issues detected in JUNO report:";
  for (const issue of juno_issues) {
    WARNING: `   [${issue.severity}] ${issue.issue}`;
  }
  WARNING: "";
  WARNING: "APOs will activate fallback mechanisms (Phase 1.5).";
  WARNING: "Enhanced verification will be applied to ensure quality.";
  WARNING: "";

  // Log for investigation
  global.trinity_docs_session.juno_incomplete = true;
  global.trinity_docs_session.juno_issues = juno_issues;
} else {
  LOG: "‚úÖ JUNO report validation: PASSED";
  global.trinity_docs_session.juno_incomplete = false;
}

// Rec 5: JUNO Execution Time Tracking
LOG: "";
LOG: "=== JUNO PERFORMANCE METRICS ===";
LOG: "";

const juno_duration = (global.trinity_docs_session.performance_metrics.juno_end - global.trinity_docs_session.performance_metrics.juno_start) / 1000;

// Count files analyzed by JUNO (estimate from various patterns)
const files_analyzed_match = juno_report.match(/Files analyzed:\s*(\d+)/i) ||
                            juno_report.match(/(\d+)\s+files? analyzed/i) ||
                            juno_report.match(/Total files:\s*(\d+)/i);
const files_analyzed = files_analyzed_match ? parseInt(files_analyzed_match[1]) : "Unknown";

// Extract discovered counts
const component_count_match = juno_report.match(/Components?:\s*(\d+)/i) ||
                              juno_report.match(/(\d+)\s+components?/i);
const component_count = component_count_match ? parseInt(component_count_match[1]) : 0;

const endpoint_count_match = juno_report.match(/API Endpoints?:\s*(\d+)/i) ||
                             juno_report.match(/(\d+)\s+endpoints?/i);
const endpoint_count = endpoint_count_match ? parseInt(endpoint_count_match[1]) : 0;

const model_count_match = juno_report.match(/Models?:\s*(\d+)/i) ||
                          juno_report.match(/(\d+)\s+models?/i);
const model_count = model_count_match ? parseInt(model_count_match[1]) : 0;

LOG: `Analysis Duration: ${juno_duration.toFixed(2)}s`;
LOG: `Files Analyzed: ${files_analyzed}`;
LOG: ``;
LOG: `Discoveries:`;
LOG: `  - Components: ${component_count}`;
LOG: `  - API Endpoints: ${endpoint_count}`;
LOG: `  - Data Models: ${model_count}`;
LOG: ``;
LOG: `Report Size: ${(juno_report.length / 1024).toFixed(2)} KB (${juno_report.length} chars)`;
LOG: `Report Location: ${audit_report_path}`;
LOG: "";

// Calculate throughput
if (files_analyzed !== "Unknown" && files_analyzed > 0) {
  const files_per_second = (files_analyzed / juno_duration).toFixed(2);
  LOG: `Throughput: ${files_per_second} files/second`;
  LOG: "";
}

LOG: "";
```

---

## Phase 1.5: APO Fallback Architecture (Rec 4)

**Purpose:** Document resilience mechanisms when JUNO report is incomplete

### When Fallback Activates

Fallback mechanisms activate when:
- JUNO report validation detects HIGH severity issues (not CRITICAL)
- Sections are present but minimal or contain placeholders
- Variable values are missing or incomplete
- `global.trinity_docs_session.juno_incomplete === true`

### APO Fallback Protocol

When JUNO report is incomplete, each APO must:

#### Step 1: Detect Incomplete Report

```javascript
// Each APO checks global state
if (global.trinity_docs_session.juno_incomplete) {
  LOG: "";
  LOG: "‚ö†Ô∏è FALLBACK MODE ACTIVATED";
  LOG: "JUNO report incomplete - using direct codebase analysis";
  LOG: "";
}
```

#### Step 2: Direct Codebase Analysis

**Use discovery templates for fallback analysis:**

**APO-1 (Diagrams):**
- If diagram variables missing: Use `trinity/templates/documentation/discovery/api-endpoint-scanner.md` and `trinity/templates/documentation/discovery/component-discovery.md` patterns
- If database schema empty: Parse database schema files directly (Prisma, TypeORM, Mongoose)
- Generate Mermaid syntax from discovered data

**APO-2 (Guides & Docs):**
- If framework not specified: Use `trinity/templates/documentation/discovery/framework-detection.md` for package.json analysis
- If environment variables missing: Use `trinity/templates/documentation/discovery/env-variable-extraction.md` for .env and process.env patterns
- Fill template variables from direct detection

**APO-3 (Config Files):**
- If .env keys missing: Use `trinity/templates/documentation/discovery/env-variable-extraction.md` for process.env.KEY patterns
- If README links undefined: Build links from expected file locations
- Validate all file references before writing

When JUNO report doesn't specify templates:
- Use default template paths: `trinity/templates/documentation/`
- Read template structure to determine required variables
- Extract variables from codebase analysis

**See trinity/templates/documentation/processes/fallback-mechanism.md for:**
- Framework detection fallback
- Component discovery fallback
- Database schema fallback
- API endpoints fallback
- Environment variables fallback
- Quality gates for fallback usage
- Logging standards

---

## Phase 2: Parallel APO Execution

**Purpose:** Generate documentation in parallel using JUNO's checklist

### Step 2.1: Invoke Three APO Instances in Parallel

```javascript
LOG: "=== PHASE 2: PARALLEL DOCUMENTATION GENERATION ===";
LOG: "";
LOG: "Invoking 3 APO instances in parallel...";
LOG: "  - APO-1: Architecture diagrams (Section A)";
LOG: "  - APO-2: API docs and guides (Section B)";
LOG: "  - APO-3: Configuration files (Section C)";
LOG: "";

// Track performance
global.trinity_docs_session.performance_metrics.apo_start = Date.now();

// Invoke 3 APO agents IN PARALLEL
// This is done by making multiple Task calls in the same message

// APO Instance 1: Architecture & Diagrams
Task({
  subagent_type: "APO",
  description: "Generate architecture diagrams",
  prompt: `
# APO-1: Architecture Diagram Generation

**Your Mission:** Generate Mermaid architecture diagrams using templates and JUNO's audit report.

## Error Handling Protocol (Rec 5)

**Tier 1: ABORT Conditions (Stop immediately, return error)**

ABORT if:
- ‚ùå Cannot read codebase (permission denied, files missing at system level)
- ‚ùå Cannot write output files (permission denied, disk full, directory creation fails)
- ‚ùå Critical templates completely missing AND cannot generate from scratch

**Tier 2: WARN and CONTINUE (Report issue, activate fallback)**

WARN if:
- ‚ö†Ô∏è JUNO section A incomplete/missing (use direct codebase analysis - see Phase 1.5)
- ‚ö†Ô∏è Some variable values missing (infer from codebase directly)
- ‚ö†Ô∏è Template file missing but can generate Mermaid from scratch
- ‚ö†Ô∏è Component list empty (use Glob to discover components)

**Tier 3: LOG INFO (Normal process updates)**

LOG if:
- ‚ÑπÔ∏è Reading templates
- ‚ÑπÔ∏è Creating diagram files
- ‚ÑπÔ∏è Replacing variables
- ‚ÑπÔ∏è Writing output files

**Error Response Format:**

\`\`\`javascript
if (TIER_1_ERROR) {
  ERROR: "";
  ERROR: "‚ùå APO-1 CRITICAL ERROR: [Error description]";
  ERROR: "Cannot proceed with diagram generation.";
  ERROR: "";
  return "APO-1 ABORTED: [Reason]";
}

if (TIER_2_ERROR) {
  WARNING: "";
  WARNING: "‚ö†Ô∏è APO-1 WARNING: [Issue description]";
  WARNING: "Activating fallback mechanism...";
  WARNING: "";
  // Continue with fallback
}
\`\`\`

## APO-1: Architecture Diagrams & Visual Documentation

**Your Mission:** Generate Mermaid architecture diagrams using templates and JUNO's audit report.

**Agent Designation:** APO-1 (Section A)

---

## Workflow Overview

Follow the **5-Phase APO Workflow** defined in:
üìÑ **[trinity/templates/documentation/processes/apo-workflow-common.md](trinity/templates/documentation/processes/apo-workflow-common.md)**

1. **Phase 1:** Read JUNO Report (`global.trinity_docs_session.audit_report`)
2. **Phase 2:** Extract Template Variables (from Section A)
3. **Phase 3:** Process Templates (generate Mermaid diagrams)
4. **Phase 4:** Write Files (to `docs/architecture/`)
5. **Phase 5:** Self-Validation (quality checks)

---

## Error Handling

**Use 3-Tier Error System** defined in:
üìÑ **[trinity/templates/documentation/processes/error-handling-protocol.md](trinity/templates/documentation/processes/error-handling-protocol.md)**

- **Tier 1 (ABORT):** JUNO report missing, component verification failed, write permission denied
- **Tier 2 (WARN):** JUNO incomplete, database schema missing, API endpoints not found
- **Tier 3 (LOG):** Progress updates, file creation confirmations

---

## APO-1 Specific Tasks

**See detailed instructions in:**
üìÑ **[trinity/templates/documentation/processes/apo-diagram-specific.md](trinity/templates/documentation/processes/apo-diagram-specific.md)**

### Diagrams to Generate:

1. **MVC Flow Diagram** (`mvc-flow.md`) - Request ‚Üí Controller ‚Üí Model ‚Üí View flow
2. **Database ER Diagram** (`database-er.md`) - Entity-relationship diagram with models
3. **API Endpoint Map** (`api-endpoint-map.md`) - API endpoint organization
4. **Component Hierarchy** (`component-hierarchy.md`) - Frontend component structure

### Mermaid Diagram Types:

- **MVC Flow:** `graph TD` (flowchart top-down)
- **Database ER:** `erDiagram` (entity-relationship)
- **API Map:** `graph LR` (flowchart left-right)
- **Components:** `graph TD` (flowchart top-down)

---

## Fallback Mechanisms

**If JUNO report incomplete** (`global.trinity_docs_session.juno_incomplete === true`):

**Use discovery templates for direct codebase analysis:**
- üìÑ **Framework Detection:** [trinity/templates/documentation/discovery/framework-detection.md](trinity/templates/documentation/discovery/framework-detection.md)
- üìÑ **Component Discovery:** [trinity/templates/documentation/discovery/component-discovery.md](trinity/templates/documentation/discovery/component-discovery.md)
- üìÑ **API Endpoint Scanner:** [trinity/templates/documentation/discovery/api-endpoint-scanner.md](trinity/templates/documentation/discovery/api-endpoint-scanner.md)

**Example Fallback:**
\`\`\`javascript
if (global.trinity_docs_session.juno_incomplete) {
  LOG: "‚ö†Ô∏è FALLBACK MODE ACTIVATED";
  LOG: "JUNO report incomplete - using direct codebase analysis";

  // Use discovery templates to extract missing data
  // See trinity/templates/documentation/processes/apo-diagram-specific.md for patterns
}
\`\`\`

---

## Critical: Component Verification (ZERO TOLERANCE)

**All component names MUST exist in codebase** - verified via Glob:

\`\`\`javascript
// Extract component names from JUNO report
const component_section = juno_report.match(/\*\*CRITICAL FOR APO-1 - Use ONLY the components listed below:\*\*(.*?)(?=\n\n\*\*|$)/s);

// Verify EACH component exists in codebase
for (const component of juno_components) {
  const possible_paths = [
    \`**/$\{component}.tsx\`,
    \`**/$\{component}.jsx\`,
    \`**/$\{component}/index.tsx\`
  ];

  let found = false;
  for (const pattern of possible_paths) {
    if (Glob(pattern).length > 0) {
      found = true;
      break;
    }
  }

  if (!found) {
    ERROR: \`‚ùå CRITICAL - Component $\{component} not found in codebase\`;
    ERROR: "ZERO TOLERANCE error - fake component names detected";
    ABORT_COMMAND();
  }
}

LOG: \`‚úÖ All $\{juno_components.length} components verified in codebase\`;
\`\`\`

**See full verification logic in:**
üìÑ **[trinity/templates/documentation/processes/apo-diagram-specific.md](trinity/templates/documentation/processes/apo-diagram-specific.md)** (lines 277-315)

---

## Self-Validation

**Run comprehensive self-validation** after generating diagrams:

üìÑ **[trinity/templates/documentation/validation/apo-self-validation.md](trinity/templates/documentation/validation/apo-self-validation.md)** - APO-1 Checklist

**Key Checks:**
- [ ] All expected diagrams created (2-4 files depending on project type)
- [ ] File ‚â•10 lines minimum
- [ ] Contains `\`\`\`mermaid` code block
- [ ] Valid Mermaid diagram type (graph/erDiagram)
- [ ] Zero placeholders (`{{VARIABLE}}`, `[TODO]`)
- [ ] All components verified in codebase (ZERO TOLERANCE)
- [ ] Mermaid syntax valid

**See validation template for implementation:**
üìÑ **[trinity/templates/documentation/validation/apo-self-validation.md](trinity/templates/documentation/validation/apo-self-validation.md)** (APO-1 validation code)

---

## Completion Summary

**Return summary in this format:**

\`\`\`
APO-1: Architecture Diagrams Complete

Files Created:
- docs/architecture/mvc-flow.md (MVC flow diagram)
- docs/architecture/database-er.md (ER diagram with X entities)
- docs/architecture/api-endpoint-map.md (X endpoints)
- docs/architecture/component-hierarchy.md (X components)

Total: [N] diagram files created

Self-Validation: ‚úÖ PASSED

Fallback Usage: [Yes/No] ([Description if used])

Status: Section A complete
\`\`\`
  `
});
</invoke>
// APO Instance 2: API Documentation & Guides
Task({
  subagent_type: "APO",
  description: "Generate API docs and guides",
  prompt: \`
# APO-2: API Documentation & Development Guides

**Your Mission:** Generate API documentation and developer guides using templates and JUNO's audit report.

**Agent Designation:** APO-2 (Section B)

---

## Workflow Overview

Follow the **5-Phase APO Workflow** defined in:
üìÑ **[trinity/templates/documentation/processes/apo-workflow-common.md](trinity/templates/documentation/processes/apo-workflow-common.md)**

1. **Phase 1:** Read JUNO Report (\`global.trinity_docs_session.audit_report\`)
2. **Phase 2:** Extract Template Variables (from Section B)
3. **Phase 3:** Process Templates (generate guides and API docs)
4. **Phase 4:** Write Files (to \`docs/guides/\` and \`docs/api/\`)
5. **Phase 5:** Self-Validation (quality checks)

---

## Error Handling

**Use 3-Tier Error System** defined in:
üìÑ **[trinity/templates/documentation/processes/error-handling-protocol.md](trinity/templates/documentation/processes/error-handling-protocol.md)**

- **Tier 1 (ABORT):** JUNO report missing, cannot read templates, write permission denied
- **Tier 2 (WARN):** JUNO incomplete, test framework unknown, deployment platform uncertain
- **Tier 3 (LOG):** Progress updates, guide creation confirmations

---

## APO-2 Specific Tasks

**See detailed instructions in:**
üìÑ **[trinity/templates/documentation/processes/apo-guide-specific.md](trinity/templates/documentation/processes/apo-guide-specific.md)**

### Guides to Generate:

1. **getting-started.md** (REQUIRED, ‚â•50 lines) - Installation, configuration, running
2. **api-development.md** (if API exists) - API development guide with examples
3. **deployment.md** (REQUIRED, ‚â•50 lines) - Deployment instructions
4. **contributing.md** (REQUIRED, ‚â•30 lines) - Contribution guidelines
5. **docs/api/README.md** (if API exists) - Complete API reference documentation

### Template Variables:

- \`{{PROJECT_NAME}}\` - From package.json
- \`{{FRAMEWORK}}\` - Express, NestJS, etc.
- \`{{TEST_FRAMEWORK}}\` - Jest, Vitest, Mocha
- \`{{TEST_COMMAND}}\` - \`npm test\` or equivalent
- \`{{BUILD_COMMAND}}\` - \`npm run build\` or equivalent
- \`{{START_COMMAND}}\` - \`npm start\` or equivalent
- \`{{DEPLOYMENT_PLATFORM}}\` - Vercel, AWS, Docker, etc.

---

## Fallback Mechanisms

**If JUNO report incomplete** (\`global.trinity_docs_session.juno_incomplete === true\`):

**Use discovery templates for direct analysis:**
- üìÑ **Framework Detection:** [trinity/templates/documentation/discovery/framework-detection.md](trinity/templates/documentation/discovery/framework-detection.md)
- üìÑ **API Endpoint Scanner:** [trinity/templates/documentation/discovery/api-endpoint-scanner.md](trinity/templates/documentation/discovery/api-endpoint-scanner.md)

**Example Fallback:**
\\\`\\\`\\\`javascript
if (global.trinity_docs_session.juno_incomplete) {
  LOG: "‚ö†Ô∏è FALLBACK MODE ACTIVATED";

  // Detect test framework from package.json
  const pkg = JSON.parse(Read('package.json'));
  const test_framework = pkg.devDependencies?.jest ? "Jest" :
                         pkg.devDependencies?.vitest ? "Vitest" :
                         pkg.devDependencies?.mocha ? "Mocha" : "Unknown";

  LOG: \\\`‚ö†Ô∏è FALLBACK: Detected test framework: \\\${test_framework}\\\`;
}
\\\`\\\`\\\`

**See full fallback patterns in:**
üìÑ **[trinity/templates/documentation/processes/apo-guide-specific.md](trinity/templates/documentation/processes/apo-guide-specific.md)** (lines 150-237)

---

## Template Processing

**Read templates from:** \`trinity/templates/documentation/guides/\`

**Process each template:**
1. Read template content
2. Replace all \`{{VARIABLES}}\` with values from JUNO report
3. Check for unreplaced placeholders (quality issue)
4. Write to output path

**Example:**
\\\`\\\`\\\`javascript
const template = Read('trinity/templates/documentation/guides/getting-started.md');

let output = template
  .replace(/{{PROJECT_NAME}}/g, variables.PROJECT_NAME)
  .replace(/{{FRAMEWORK}}/g, variables.FRAMEWORK)
  .replace(/{{TEST_COMMAND}}/g, variables.TEST_COMMAND);

// Check for unreplaced variables
const unreplaced = output.match(/{{[A-Z_]+}}/g);
if (unreplaced) {
  WARNING: \\\`‚ö†Ô∏è Unreplaced variables in output: \\\${unreplaced.join(', ')}\\\`;
}

Write('docs/guides/getting-started.md', output);
\\\`\\\`\\\`

---

## Self-Validation

**Run comprehensive self-validation** after generating guides:

üìÑ **[trinity/templates/documentation/validation/apo-self-validation.md](trinity/templates/documentation/validation/apo-self-validation.md)** - APO-2 Checklist

**Key Checks:**
- [ ] All expected guides created (4-5 files depending on project type)
- [ ] File ‚â•50 lines minimum (getting-started, deployment)
- [ ] File ‚â•30 lines minimum (contributing)
- [ ] Contains ‚â•2 code blocks per guide
- [ ] Zero placeholders (\`{{VARIABLE}}\`, \`[TODO]\`)
- [ ] Internal links valid
- [ ] Framework-specific examples accurate

**See validation template for implementation:**
üìÑ **[trinity/templates/documentation/validation/apo-self-validation.md](trinity/templates/documentation/validation/apo-self-validation.md)** (APO-2 validation code)

---

## Completion Summary

**Return summary in this format:**

\\\`\\\`\\\`
APO-2: API Documentation & Guides Complete

Files Created:
- docs/guides/getting-started.md (62 lines, 3 code blocks)
- docs/guides/api-development.md (78 lines, 5 code blocks)
- docs/guides/deployment.md (54 lines, 4 code blocks)
- docs/guides/contributing.md (32 lines)
- docs/api/README.md (91 lines, 8 endpoints documented)

Total: [N] guide files created

Self-Validation: ‚úÖ PASSED

Fallback Usage: [Yes/No] ([Description if used])

Status: Section B complete
\\\`\\\`\\\`
  \`
});

// APO Instance 3: Configuration Files
Task({
  subagent_type: "APO",
  description: "Generate config files",
  prompt: \`
# APO-3: Configuration Files & Setup Documentation

**Your Mission:** Generate .env.example and update README.md using templates and JUNO's audit report.

**Agent Designation:** APO-3 (Section C)

---

## Workflow Overview

Follow the **5-Phase APO Workflow** defined in:
üìÑ **[trinity/templates/documentation/processes/apo-workflow-common.md](trinity/templates/documentation/processes/apo-workflow-common.md)**

1. **Phase 1:** Read JUNO Report (\`global.trinity_docs_session.audit_report\`)
2. **Phase 2:** Extract Template Variables (from Section C)
3. **Phase 3:** Process Templates (generate .env.example and README updates)
4. **Phase 4:** Write Files (to project root)
5. **Phase 5:** Self-Validation (quality and security checks)

---

## Error Handling

**Use 3-Tier Error System** defined in:
üìÑ **[trinity/templates/documentation/processes/error-handling-protocol.md](trinity/templates/documentation/processes/error-handling-protocol.md)**

- **Tier 1 (ABORT):** JUNO report missing, write permission denied, **SECURITY VIOLATION** (real secrets detected)
- **Tier 2 (WARN):** No environment variables discovered, README.md doesn't exist
- **Tier 3 (LOG):** Progress updates, file creation confirmations

---

## APO-3 Specific Tasks

**See detailed instructions in:**
üìÑ **[trinity/templates/documentation/processes/apo-config-specific.md](trinity/templates/documentation/processes/apo-config-specific.md)**

### Files to Generate:

1. **.env.example** (REQUIRED, ‚â•5 variables) - Environment variable template with **SAFE PLACEHOLDERS ONLY**
2. **README.md** (REQUIRED, append/update) - Add Documentation, Configuration, Quick Start sections

### Template Variables:

- \`{{ENV_VARIABLES}}\` - List of environment variables from codebase
- \`{{PORT}}\` - Default port number
- \`{{DATABASE_URL}}\` - Database connection string pattern
- \`{{PROJECT_NAME}}\` - From package.json
- \`{{DESCRIPTION}}\` - Project description

---

## CRITICAL: Security Requirements

**NEVER include real secrets in .env.example:**

‚ùå **Forbidden:**
- Real API keys, passwords, JWT secrets, database credentials
- Production values, live keys, actual tokens

‚úÖ **Required:**
- Safe placeholders: \`your_api_key_here\`, \`your_jwt_secret_here\`, \`change_in_production\`
- Example values: \`example@email.com\`, \`http://localhost:3000\`, \`5432\`

**Security Validation:**
\\\`\\\`\\\`javascript
const dangerous_patterns = [
  /sk_live_[a-zA-Z0-9]+/,  // Stripe live keys
  /AKIA[0-9A-Z]{16}/,      // AWS access keys
  /AIza[0-9A-Za-z\\\\-_]{35}/,  // Google API keys
  /[0-9a-f]{32}/,          // MD5 hashes (potential secrets)
];

const env_content = Read('.env.example');
for (const pattern of dangerous_patterns) {
  if (pattern.test(env_content)) {
    ERROR: "‚ùå SECURITY VIOLATION - Real secrets detected in .env.example";
    ERROR: "This is a CRITICAL error - must use safe placeholders only";
    ABORT_COMMAND();
  }
}

LOG: "‚úÖ Security check passed: No real secrets in .env.example";
\\\`\\\`\\\`

**See full security validation in:**
üìÑ **[trinity/templates/documentation/processes/apo-config-specific.md](trinity/templates/documentation/processes/apo-config-specific.md)** (lines 61-78)

---

## Fallback Mechanisms

**If JUNO report incomplete** (\`global.trinity_docs_session.juno_incomplete === true\`):

**Use discovery template for direct analysis:**
- üìÑ **Env Variable Extraction:** [trinity/templates/documentation/discovery/env-variable-extraction.md](trinity/templates/documentation/discovery/env-variable-extraction.md)

**Example Fallback:**
\\\`\\\`\\\`javascript
if (global.trinity_docs_session.juno_incomplete) {
  LOG: "‚ö†Ô∏è FALLBACK MODE ACTIVATED";

  // Extract env variables from codebase
  const env_files = ['.env', '.env.local', '.env.example'];
  const discovered_vars = [];

  for (const file of env_files) {
    if (exists(file)) {
      const content = Read(file);
      const lines = content.split('\\\\n');
      for (const line of lines) {
        if (line.match(/^[A-Z_]+=/) {
          const var_name = line.split('=')[0];
          discovered_vars.push(var_name);
        }
      }
    }
  }

  // Also search for process.env usage
  const code_files = Glob('src/**/*.{ts,js}');
  for (const file of code_files) {
    const content = Read(file);
    const matches = content.match(/process\\\\.env\\\\.([A-Z_]+)/g);
    if (matches) {
      for (const match of matches) {
        const var_name = match.replace('process.env.', '');
        if (!discovered_vars.includes(var_name)) {
          discovered_vars.push(var_name);
        }
      }
    }
  }

  LOG: \\\`‚ö†Ô∏è FALLBACK: Discovered \\\${discovered_vars.length} environment variables\\\`;
}
\\\`\\\`\\\`

---

## README.md Updates

**IMPORTANT: Do NOT overwrite README.md - only append/update sections**

**Sections to Add:**
- \`## Documentation\` - Links to docs/guides/
- \`## Configuration\` - Instructions for .env setup
- \`## Quick Start\` - Fast getting started steps

**Example:**
\\\`\\\`\\\`javascript
const readme_exists = exists('README.md');

if (readme_exists) {
  const existing_readme = Read('README.md');

  // Check if sections already exist
  if (!existing_readme.includes('## Documentation')) {
    const documentation_section = \\\`
## Documentation

Complete documentation is available in the [\\\`docs/\\\`](docs/) directory:

- [Getting Started Guide](docs/guides/getting-started.md)
- [API Development](docs/guides/api-development.md)
- [Deployment Guide](docs/guides/deployment.md)
- [Contributing Guidelines](docs/guides/contributing.md)

\\\`;

    // Append sections to README
    const updated_readme = existing_readme + '\\\\n' + documentation_section;
    Write('README.md', updated_readme);

    LOG: "‚úÖ Updated README.md with documentation links";
  } else {
    LOG: "‚ÑπÔ∏è README.md already contains documentation section - skipping";
  }
} else {
  WARNING: "‚ö†Ô∏è README.md doesn't exist - creating new README";
  // Create minimal README with all sections
}
\\\`\\\`\\\`

---

## Self-Validation

**Run comprehensive self-validation** after generating config files:

üìÑ **[trinity/templates/documentation/validation/apo-self-validation.md](trinity/templates/documentation/validation/apo-self-validation.md)** - APO-3 Checklist

**Key Checks:**
- [ ] .env.example created with ‚â•5 variables (or all discovered)
- [ ] Variables grouped by purpose (# comment headers)
- [ ] All values are safe placeholders (no real secrets)
- [ ] **SECURITY VALIDATED:** Zero real API keys, passwords, tokens
- [ ] README.md updated (not overwritten)
- [ ] Documentation section added with links
- [ ] Configuration section added with .env instructions

**See validation template for implementation:**
üìÑ **[trinity/templates/documentation/validation/apo-self-validation.md](trinity/templates/documentation/validation/apo-self-validation.md)** (APO-3 validation code with security checks)

---

## Completion Summary

**Return summary in this format:**

\\\`\\\`\\\`
APO-3: Configuration Files Complete

Files Created/Updated:
- .env.example (12 variables, grouped by purpose)
- README.md (updated with Documentation, Configuration sections)

Total: 2 files

Self-Validation: ‚úÖ PASSED
Security Check: ‚úÖ PASSED (zero real secrets)

Fallback Usage: [Yes/No] ([Description if used])

Status: Section C complete
\\\`\\\`\\\`
  \`
});

## Phase 3: Enhanced Verification (Rec 7)

**Purpose:** Verify all documentation from checklist was created AND validate content quality

### Step 3.1: Read JUNO's Audit Report

```javascript
LOG: "=== PHASE 3: ENHANCED VERIFICATION ===";
LOG: "";
LOG: "Reading JUNO's audit report to verify completeness...";
LOG: "";

// Track performance
global.trinity_docs_session.performance_metrics.verification_start = Date.now();

const audit_report = Read(audit_report_path);

// Parse expected file counts from report
let expected_diagrams = 0;
let expected_guides = 0;
let expected_api_docs = 0;
let expected_config = 0;

// Count "Required: YES" items in each section
const section_a = audit_report.match(/SECTION A:.*?(?=SECTION B:)/s);
const section_b = audit_report.match(/SECTION B:.*?(?=SECTION C:)/s);
const section_c = audit_report.match(/SECTION C:.*$/s);

if (section_a) {
  expected_diagrams = (section_a[0].match(/Required: YES/g) || []).length;
}

if (section_b) {
  const required_count = (section_b[0].match(/Required: YES/g) || []).length;
  // Separate guides from API docs
  expected_guides = required_count > 0 ? required_count - 1 : 0; // Assume 1 API doc + N guides
  expected_api_docs = required_count > 0 ? 1 : 0;
}

if (section_c) {
  expected_config = (section_c[0].match(/Required: YES/g) || []).length;
}

LOG: `Expected documentation:`;
LOG: `  - Diagrams: ${expected_diagrams} files`;
LOG: `  - Guides: ${expected_guides} files`;
LOG: `  - API Docs: ${expected_api_docs} files`;
LOG: `  - Config: ${expected_config} files`;
LOG: `  - Total: ${expected_diagrams + expected_guides + expected_api_docs + expected_config} files`;
LOG: "";
```

### Step 3.2: Verify File Creation (Tier 1: Completion)

```javascript
LOG: "=== TIER 1: FILE COMPLETION VERIFICATION ===";
LOG: "";
LOG: "Checking if all expected files were created...";
LOG: "";

// See trinity/templates/documentation/configuration/documentation-structure.md for verification patterns
const diagram_files = Glob({pattern: "docs/images/*.md"});
const guide_files = Glob({pattern: "docs/guides/*.md"});
const api_doc_files = Glob({pattern: "docs/api/*.md"});

const diagrams_ok = diagram_files.length === expected_diagrams;
const guides_ok = guide_files.length === expected_guides;
const api_docs_ok = api_doc_files.length === expected_api_docs;

LOG: `Diagrams: ${diagram_files.length}/${expected_diagrams} ${diagrams_ok ? "‚úÖ" : "‚ùå"}`;
diagram_files.forEach(f => LOG: `  ‚úÖ ${f}`);
if (!diagrams_ok) ERROR: `‚ùå Diagram count mismatch: expected ${expected_diagrams}, got ${diagram_files.length}`;

LOG: `Guides: ${guide_files.length}/${expected_guides} ${guides_ok ? "‚úÖ" : "‚ùå"}`;
guide_files.forEach(f => LOG: `  ‚úÖ ${f}`);
if (!guides_ok) ERROR: `‚ùå Guide count mismatch: expected ${expected_guides}, got ${guide_files.length}`;

LOG: `API Docs: ${api_doc_files.length}/${expected_api_docs} ${api_docs_ok ? "‚úÖ" : "‚ùå"}`;
api_doc_files.forEach(f => LOG: `  ‚úÖ ${f}`);

if (!api_docs_ok) {
  ERROR: "";
  ERROR: `‚ùå API doc count mismatch: expected ${expected_api_docs}, got ${api_doc_files.length}`;
}

// Check config files
const env_example_exists = Glob({pattern: "**/.env.example"}).length > 0;
const config_ok = env_example_exists;

LOG: `Config: ${config_ok ? "1/1" : "0/1"} ${config_ok ? "‚úÖ" : "‚ùå"}`;
if (env_example_exists) {
  LOG: "  ‚úÖ .env.example";
}

if (!config_ok) {
  ERROR: "";
  ERROR: "‚ùå .env.example file missing";
}

// Tier 1 overall
const tier1_passed = diagrams_ok && guides_ok && api_docs_ok && config_ok;

LOG: "";
if (tier1_passed) {
  LOG: "‚úÖ TIER 1 (COMPLETION): PASSED";
} else {
  ERROR: "‚ùå TIER 1 (COMPLETION): FAILED";
  ERROR: "";
  ERROR: "Not all expected files were created.";
  ERROR: "Review APO execution logs to identify failures.";
  ERROR: "";
  ABORT_COMMAND();
}

LOG: "";
```

### Step 3.3: Content Quality Verification (Tier 2)

```javascript
LOG: "=== TIER 2: CONTENT QUALITY VERIFICATION ===";
LOG: "";

const all_docs = [...diagram_files, ...guide_files, ...api_doc_files];

const verification_issues = {
  template_placeholders: [],
  broken_links: [],
  mermaid_errors: [],
  short_content: [],
  stub_content: [] // Rec 22: Stub content detection
};

// Check 1: Template Placeholder Detection
LOG: "Checking for template placeholders ({{VARIABLE}} syntax)...";

for (const file of all_docs) {
  const content = Read(file);
  const placeholders = content.match(/\{\{[^}]+\}\}/g);

  if (placeholders) {
    for (const ph of placeholders) {
      verification_issues.template_placeholders.push({
        file: file,
        placeholder: ph
      });
    }
  }
}

if (verification_issues.template_placeholders.length === 0) {
  LOG: "  ‚úÖ No template placeholders found";
} else {
  LOG: `  ‚ùå Found ${verification_issues.template_placeholders.length} template placeholders`;
  for (const issue of verification_issues.template_placeholders) {
    ERROR: `     ${issue.file}: ${issue.placeholder}`;
  }
}

// Check 2: Internal Link Validation
LOG: "";
LOG: "Validating internal markdown links...";

for (const file of all_docs) {
  const content = Read(file);
  const markdown_links = content.matchAll(/\[([^\]]+)\]\(([^)]+)\)/g);

  for (const link of markdown_links) {
    const link_text = link[1];
    const link_target = link[2];

    // Skip external links and anchors
    if (link_target.startsWith('http') || link_target.startsWith('#')) {
      continue;
    }

    // Resolve relative path
    const file_dir = file.split('/').slice(0, -1).join('/');
    let resolved_path = link_target;

    // Handle ../
    if (link_target.startsWith('../')) {
      const parts = link_target.split('/');
      const up_levels = parts.filter(p => p === '..').length;
      const dir_parts = file_dir.split('/');
      const base = dir_parts.slice(0, dir_parts.length - up_levels).join('/');
      const rest = parts.filter(p => p !== '..').join('/');
      resolved_path = base + '/' + rest;
    } else if (link_target.startsWith('./')) {
      resolved_path = file_dir + '/' + link_target.slice(2);
    } else if (!link_target.startsWith('/')) {
      resolved_path = file_dir + '/' + link_target;
    } else {
      resolved_path = link_target.slice(1); // Remove leading /
    }

    // Check if target exists
    if (!exists(resolved_path)) {
      verification_issues.broken_links.push({
        file: file,
        link_text: link_text,
        target: link_target,
        resolved: resolved_path
      });
    }
  }
}

if (verification_issues.broken_links.length === 0) {
  LOG: "  ‚úÖ All internal links valid";
} else {
  LOG: `  ‚ùå Found ${verification_issues.broken_links.length} broken links`;
  for (const issue of verification_issues.broken_links) {
    ERROR: `     ${issue.file}: [${issue.link_text}](${issue.target}) -> ${issue.resolved} (NOT FOUND)`;
  }
}

// Check 3: Mermaid Syntax Validation
LOG: "";
LOG: "Validating Mermaid diagram syntax...";

for (const file of diagram_files) {
  const content = Read(file);
  const mermaid_match = content.match(/```mermaid([\s\S]+?)```/);

  if (!mermaid_match) {
    verification_issues.mermaid_errors.push({
      file: file,
      error: "No Mermaid code block found (missing ```mermaid)"
    });
    continue;
  }

  const mermaid_block = mermaid_match[1].trim();

  // Validate diagram type
  const valid_types = ['graph', 'flowchart', 'sequenceDiagram', 'erDiagram', 'classDiagram', 'stateDiagram', 'journey', 'gantt'];
  const has_valid_type = valid_types.some(type => mermaid_block.startsWith(type));

  if (!has_valid_type) {
    verification_issues.mermaid_errors.push({
      file: file,
      error: `Invalid diagram type. Must start with one of: ${valid_types.join(', ')}`
    });
    continue;
  }

  // Check for minimum content
  if (mermaid_block.length < 50) {
    verification_issues.mermaid_errors.push({
      file: file,
      error: `Mermaid block too short (${mermaid_block.length} chars, expected 50+)`
    });
    continue;
  }

  // Check for placeholders in Mermaid
  if (mermaid_block.includes("{{") || mermaid_block.includes("[Add ") || mermaid_block.includes("[Define ")) {
    verification_issues.mermaid_errors.push({
      file: file,
      error: "Mermaid block contains placeholders or incomplete syntax"
    });
    continue;
  }
}

if (verification_issues.mermaid_errors.length === 0) {
  LOG: "  ‚úÖ All Mermaid diagrams valid";
} else {
  LOG: `  ‚ùå Found ${verification_issues.mermaid_errors.length} Mermaid errors`;
  for (const issue of verification_issues.mermaid_errors) {
    ERROR: `     ${issue.file}: ${issue.error}`;
  }
}

// Check 4: Content Length (short files may indicate incomplete generation)
LOG: "";
LOG: "Checking content length...";

for (const file of all_docs) {
  const content = Read(file);
  const min_length = file.includes('/images/') ? 100 : 200; // Diagrams can be shorter

  if (content.length < min_length) {
    verification_issues.short_content.push({
      file: file,
      length: content.length,
      expected: min_length
    });
  }
}

if (verification_issues.short_content.length === 0) {
  LOG: "  ‚úÖ All files have substantial content";
} else {
  LOG: `  ‚ö†Ô∏è Found ${verification_issues.short_content.length} short files`;
  for (const issue of verification_issues.short_content) {
    WARNING: `     ${issue.file}: ${issue.length} chars (expected ${issue.expected}+)`;
  }
}

// Check 5: Stub Content Detection (Rec 22)
LOG: "";
LOG: "Checking for stub content (coming soon, TODO, etc.)...";

verification_issues.stub_content = [];

const stub_patterns = [
  /coming soon/gi,
  /to be added/gi,
  /will be added/gi,
  /\[TODO\]/gi,
  /\[TBD\]/gi,
  /to be documented/gi,
  /see .* \(coming soon\)/gi,
  /placeholder/gi,
  /under construction/gi,
  /work in progress/gi
];

for (const file of all_docs) {
  const content = Read(file);

  for (const pattern of stub_patterns) {
    const matches = content.match(pattern);
    if (matches) {
      // Check if stub content is in acceptable context (Future Enhancements section)
      const has_future_section = content.match(/##+ Future Enhancements|##+ Roadmap|##+ Coming Soon/i);

      // If stub content found, check context
      let in_future_section = false;
      if (has_future_section) {
        // Simple heuristic: check if match is after Future Enhancements heading
        const future_section_index = content.search(/##+ Future Enhancements|##+ Roadmap|##+ Coming Soon/i);
        const match_index = content.search(pattern);
        in_future_section = match_index > future_section_index;
      }

      if (!in_future_section) {
        verification_issues.stub_content.push({
          file: file,
          pattern: matches[0],
          context: content.substring(Math.max(0, content.search(pattern) - 50), Math.min(content.length, content.search(pattern) + 100))
        });
      }
    }
  }
}

if (verification_issues.stub_content.length === 0) {
  LOG: "  ‚úÖ No stub content detected";
} else {
  LOG: `  ‚ùå Found ${verification_issues.stub_content.length} instances of stub content`;
  for (const issue of verification_issues.stub_content) {
    ERROR: `     ${issue.file}: "${issue.pattern}"`;
  }
}

// Rec 16: Fail-Fast Logic - ABORT immediately on first critical failure
// Check each issue type and ABORT with specific error messages

LOG: "";

// Check 1: Template Placeholders (CRITICAL)
if (verification_issues.template_placeholders.length > 0) {
  ERROR: "";
  ERROR: "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó";
  ERROR: "‚ïë  ‚ùå CRITICAL FAILURE: TEMPLATE PLACEHOLDERS DETECTED     ‚ïë";
  ERROR: "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù";
  ERROR: "";
  ERROR: `Found ${verification_issues.template_placeholders.length} unreplaced template variables in documentation:`;
  ERROR: "";
  for (const issue of verification_issues.template_placeholders) {
    ERROR: `  File: ${issue.file}`;
    ERROR: `  Placeholder: ${issue.placeholder}`;
    ERROR: "";
  }
  ERROR: "ROOT CAUSE ANALYSIS:";
  ERROR: "  1. APO did not replace all {{VARIABLE}} placeholders";
  ERROR: "  2. JUNO report may have incomplete variable values";
  ERROR: "  3. Template files may have undocumented variables";
  ERROR: "";
  ERROR: "RESOLUTION:";
  ERROR: "  - Check JUNO report for missing variable values";
  ERROR: "  - Verify APO read and processed JUNO report correctly";
  ERROR: "  - Ensure templates use only documented variables";
  ERROR: "";
  ERROR: "Documentation generation ABORTED - placeholders must be resolved.";
  ERROR: "";
  ABORT_COMMAND();
}

// Check 2: Broken Links (CRITICAL)
if (verification_issues.broken_links.length > 0) {
  ERROR: "";
  ERROR: "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó";
  ERROR: "‚ïë  ‚ùå CRITICAL FAILURE: BROKEN LINKS DETECTED              ‚ïë";
  ERROR: "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù";
  ERROR: "";
  ERROR: `Found ${verification_issues.broken_links.length} broken internal links in documentation:`;
  ERROR: "";
  for (const issue of verification_issues.broken_links) {
    ERROR: `  File: ${issue.file}`;
    ERROR: `  Link: [${issue.link_text}](${issue.target})`;
    ERROR: `  Resolved Path: ${issue.resolved}`;
    ERROR: `  Status: NOT FOUND`;
    ERROR: "";
  }
  ERROR: "ROOT CAUSE ANALYSIS:";
  ERROR: "  1. APO created links to files that don't exist";
  ERROR: "  2. JUNO report listed files that APO didn't create";
  ERROR: "  3. File paths in documentation don't match actual structure";
  ERROR: "";
  ERROR: "RESOLUTION:";
  ERROR: "  - Verify all expected files were created by APOs";
  ERROR: "  - Check JUNO report file paths match actual output paths";
  ERROR: "  - Ensure APO-3 README validation passed";
  ERROR: "";
  ERROR: "Documentation generation ABORTED - broken links unacceptable.";
  ERROR: "";
  ABORT_COMMAND();
}

// Check 3: Mermaid Syntax Errors (CRITICAL)
if (verification_issues.mermaid_errors.length > 0) {
  ERROR: "";
  ERROR: "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó";
  ERROR: "‚ïë  ‚ùå CRITICAL FAILURE: INVALID MERMAID SYNTAX            ‚ïë";
  ERROR: "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù";
  ERROR: "";
  ERROR: `Found ${verification_issues.mermaid_errors.length} Mermaid syntax errors in diagrams:`;
  ERROR: "";
  for (const issue of verification_issues.mermaid_errors) {
    ERROR: `  File: ${issue.file}`;
    ERROR: `  Error: ${issue.error}`;
    ERROR: "";
  }
  ERROR: "ROOT CAUSE ANALYSIS:";
  ERROR: "  1. APO-1 generated invalid Mermaid syntax";
  ERROR: "  2. Template files contain invalid Mermaid structure";
  ERROR: "  3. JUNO report provided malformed data for diagrams";
  ERROR: "";
  ERROR: "RESOLUTION:";
  ERROR: "  - Verify templates have valid Mermaid syntax";
  ERROR: "  - Check JUNO report entity/relationship data is well-formed";
  ERROR: "  - Ensure APO-1 self-validation caught this before completion";
  ERROR: "";
  ERROR: "Documentation generation ABORTED - invalid diagrams unacceptable.";
  ERROR: "";
  ABORT_COMMAND();
}

// Check 4: Stub Content (CRITICAL) - Rec 22
if (verification_issues.stub_content.length > 0) {
  ERROR: "";
  ERROR: "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó";
  ERROR: "‚ïë  ‚ùå CRITICAL FAILURE: STUB CONTENT DETECTED              ‚ïë";
  ERROR: "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù";
  ERROR: "";
  ERROR: `Found ${verification_issues.stub_content.length} instances of stub content in documentation:`;
  ERROR: "";
  for (const issue of verification_issues.stub_content) {
    ERROR: `  File: ${issue.file}`;
    ERROR: `  Pattern: "${issue.pattern}"`;
    ERROR: `  Context: ${issue.context.substring(0, 100)}...`;
    ERROR: "";
  }
  ERROR: "ROOT CAUSE ANALYSIS:";
  ERROR: "  1. APO-2 generated incomplete documentation with placeholder text";
  ERROR: "  2. JUNO report provided insufficient data for complete documentation";
  ERROR: "  3. Documentation was rushed and contains 'TODO' or 'coming soon' markers";
  ERROR: "";
  ERROR: "RESOLUTION:";
  ERROR: "  - Ensure JUNO report provides complete, actionable data";
  ERROR: "  - Verify APO-2 completes all documentation sections";
  ERROR: "  - Remove all stub content - documentation must be production-ready";
  ERROR: "  - Only 'Future Enhancements' sections may reference future features";
  ERROR: "";
  ERROR: "Documentation generation ABORTED - stub content unacceptable for production.";
  ERROR: "";
  ABORT_COMMAND();
}

// Check 5: Short Content (WARNING only - not critical)
if (verification_issues.short_content.length > 0) {
  WARNING: "";
  WARNING: `‚ö†Ô∏è WARNING: ${verification_issues.short_content.length} files have minimal content`;
  for (const issue of verification_issues.short_content) {
    WARNING: `  ${issue.file}: ${issue.length} chars (expected ${issue.expected}+)`;
  }
  WARNING: "";
  WARNING: "This may indicate incomplete documentation but does not block generation.";
  WARNING: "";
}

// All Tier 2 checks passed
LOG: "‚úÖ TIER 2 (CONTENT QUALITY): PASSED - No critical issues detected";
LOG: "";
```

### Step 3.4: Accuracy Verification (Tier 3 - Warnings Only)

```javascript
LOG: "=== TIER 3: ACCURACY VERIFICATION (NON-BLOCKING) ===";
LOG: "";

const accuracy_warnings = [];

// Check 1: API Endpoint Count Accuracy (Rec 14: Enhanced Regex Patterns)
LOG: "Checking API endpoint count accuracy...";

// Count documented endpoints in API docs (using multiple patterns)
let documented_endpoint_count = 0;
if (api_doc_files.length > 0) {
  const api_content = Read(api_doc_files[0]);

  // Rec 14: Multiple endpoint detection patterns
  const endpoint_patterns = [
    // Markdown list format: - GET /api/users
    /^[-*]\s+(GET|POST|PUT|PATCH|DELETE)\s+\/[^\s\n]+/gm,
    // Direct format: GET /api/users
    /^(GET|POST|PUT|PATCH|DELETE)\s+\/[^\s\n]+/gm,
    // Heading format: ### GET /api/users
    /^#{1,6}\s+(GET|POST|PUT|PATCH|DELETE)\s+\/[^\s\n]+/gm,
    // Bold format: **GET /api/users**
    /\*\*(GET|POST|PUT|PATCH|DELETE)\s+\/[^\s\n]+\*\*/gm,
    // Code format: `GET /api/users`
    /`(GET|POST|PUT|PATCH|DELETE)\s+\/[^\s\n]+`/gm
  ];

  const found_endpoints = new Set();

  for (const pattern of endpoint_patterns) {
    const matches = api_content.matchAll(pattern);
    for (const match of matches) {
      // Extract method and path
      const full_match = match[0];
      const method_match = full_match.match(/(GET|POST|PUT|PATCH|DELETE)/);
      const path_match = full_match.match(/\/[^\s\n`*]+/);

      if (method_match && path_match) {
        const endpoint_key = `${method_match[0]} ${path_match[0]}`;
        found_endpoints.add(endpoint_key);
      }
    }
  }

  documented_endpoint_count = found_endpoints.size;

  LOG: `  Detection patterns used: ${endpoint_patterns.length}`;
  LOG: `  Unique endpoints found: ${documented_endpoint_count}`;
}

// Count actual endpoints in codebase
const route_patterns = [
  "server/routes/**/*.{ts,js}",
  "src/routes/**/*.{ts,js}",
  "api/**/*.{ts,js}",
  "server/api/**/*.{ts,js}"
];

let actual_endpoint_count = 0;
for (const pattern of route_patterns) {
  const route_files = Glob({pattern: pattern});

  for (const route_file of route_files) {
    const content = Read(route_file);
    const http_methods = ['get', 'post', 'put', 'patch', 'delete'];

    for (const method of http_methods) {
      const regex = new RegExp(`\\.(${method})\\(['"\`]([^'"\`]+)['"\`]`, 'g');
      const matches = content.match(regex);
      actual_endpoint_count += matches ? matches.length : 0;
    }
  }
}

const endpoint_diff = Math.abs(documented_endpoint_count - actual_endpoint_count);

// Rec 14: Increased tolerance from ¬±1 to ¬±5 (reduces false warnings)
if (endpoint_diff > 5) {
  accuracy_warnings.push({
    severity: "MEDIUM",
    category: "API Documentation",
    issue: `Endpoint count mismatch: documented ${documented_endpoint_count}, actual ${actual_endpoint_count} (diff: ${endpoint_diff})`
  });
}

LOG: `  Documented endpoints: ${documented_endpoint_count}`;
LOG: `  Actual endpoints: ${actual_endpoint_count}`;
LOG: `  Difference: ${endpoint_diff} ${endpoint_diff <= 5 ? "‚úÖ" : "‚ö†Ô∏è"} (tolerance: ¬±5)`;

// Check 2: Component Count Accuracy (if frontend detected)
LOG: "";
LOG: "Checking component count accuracy...";

// Count components mentioned in component hierarchy diagram
let documented_component_count = 0;
const component_diagrams = diagram_files.filter(f => f.includes('component-hierarchy'));

if (component_diagrams.length > 0) {
  const diagram_content = Read(component_diagrams[0]);
  // Count nodes in Mermaid flowchart (rough estimate)
  const node_matches = diagram_content.match(/[A-Z][a-zA-Z0-9_]+(?=\[|-->)/g);
  documented_component_count = node_matches ? new Set(node_matches).size : 0;
}

// Count actual component files
const component_patterns = [
  "client/**/*.{tsx,jsx}",
  "src/**/*.{tsx,jsx}",
  "client/**/*.vue",
  "src/**/*.vue"
];

let actual_component_count = 0;
for (const pattern of component_patterns) {
  const files = Glob({pattern: pattern});
  // Filter out test files, main files, index files
  const actual = files.filter(f =>
    !f.includes('.test.') &&
    !f.includes('.spec.') &&
    !f.endsWith('main.tsx') &&
    !f.endsWith('index.tsx')
  );
  actual_component_count += actual.length;
}

const component_diff = Math.abs(documented_component_count - actual_component_count);

if (component_diff > 2) {
  accuracy_warnings.push({
    severity: "LOW",
    category: "Component Documentation",
    issue: `Component count mismatch: documented ${documented_component_count}, actual ${actual_component_count} (diff: ${component_diff})`
  });
}

LOG: `  Documented components: ${documented_component_count}`;
LOG: `  Actual components: ${actual_component_count}`;
LOG: `  Difference: ${component_diff} ${component_diff <= 2 ? "‚úÖ" : "‚ö†Ô∏è"}`;

// Check 3: Testing Framework Accuracy
LOG: "";
LOG: "Checking testing framework accuracy...";

// Check what's mentioned in getting-started guide
let documented_framework = "None";
const getting_started = guide_files.find(f => f.includes('getting-started'));

if (getting_started) {
  const guide_content = Read(getting_started);

  if (guide_content.includes("Jest")) {
    documented_framework = "Jest";
  } else if (guide_content.includes("Vitest")) {
    documented_framework = "Vitest";
  } else if (guide_content.includes("Mocha")) {
    documented_framework = "Mocha";
  }
}

// Detect actual testing framework
let actual_framework = "None";
const pkg = JSON.parse(Read("package.json"));

if (pkg.devDependencies?.jest || pkg.dependencies?.jest) {
  actual_framework = "Jest";
} else if (pkg.devDependencies?.vitest || pkg.dependencies?.vitest) {
  actual_framework = "Vitest";
} else if (pkg.devDependencies?.mocha || pkg.dependencies?.mocha) {
  actual_framework = "Mocha";
}

if (documented_framework !== actual_framework) {
  accuracy_warnings.push({
    severity: "HIGH",
    category: "Testing Framework",
    issue: `Framework mismatch: documented "${documented_framework}", actual "${actual_framework}"`
  });
}

LOG: `  Documented framework: ${documented_framework}`;
LOG: `  Actual framework: ${actual_framework}`;
LOG: `  Match: ${documented_framework === actual_framework ? "‚úÖ" : "‚ö†Ô∏è"}`;

// Tier 3 Summary
LOG: "";
if (accuracy_warnings.length === 0) {
  LOG: "‚úÖ TIER 3 (ACCURACY): PASSED - No inaccuracies detected";
} else {
  WARNING: "";
  WARNING: `‚ö†Ô∏è TIER 3 (ACCURACY): ${accuracy_warnings.length} WARNINGS`;
  WARNING: "";
  WARNING: "Documentation contains minor inaccuracies (non-blocking):";
  for (const warning of accuracy_warnings) {
    WARNING: `   [${warning.severity}] ${warning.category}: ${warning.issue}`;
  }
  WARNING: "";
  WARNING: "These do not block deployment but should be reviewed.";
  WARNING: "";
}

LOG: "";
```

### Step 3.5: Generate Verification Report

```javascript
LOG: "Generating verification report...";
LOG: "";

const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
const report_path = `trinity/reports/VERIFICATION-REPORT-${timestamp}.md`;

// Rec 15: Performance timing variables (estimated for individual phases)
const apo1_time = "N/A"; // Individual APO times not tracked (parallel execution)
const apo2_time = "N/A";
const apo3_time = "N/A";
const tier1_time = "~1s"; // Estimated based on typical execution
const tier2_time = "~2s";
const tier3_time = "~1s";
const tier4_time = "~0.5s";
const juno_files_analyzed = "Unknown"; // Would need to parse from JUNO report

// Calculate quality score
const tier1_score = tier1_passed ? 40 : 0;
const tier2_score = tier2_critical_issues === 0 ? 40 : 0;

// Tier 3: 15 points, deduct based on severity
let tier3_score = 15;
for (const warning of accuracy_warnings) {
  if (warning.severity === "HIGH") tier3_score -= 5;
  else if (warning.severity === "MEDIUM") tier3_score -= 3;
  else tier3_score -= 1;
}
tier3_score = Math.max(0, tier3_score);

// Tier 4: Excellence (Rec 23: Automated Readability Scoring)
let tier4_score = 0;
const tier4_checks = {
  code_examples: 0,
  clear_explanations: 0,
  step_by_step: 0,
  api_examples: 0,
  professional_presentation: 0
};

// Check 1: Code Examples (count code blocks in guides)
let total_code_blocks = 0;
for (const file of guide_files) {
  const content = Read(file);
  const code_blocks = (content.match(/\`\`\`/g) || []).length / 2; // Each block has opening and closing
  total_code_blocks += code_blocks;
}
if (total_code_blocks >= guide_files.length * 2) {
  tier4_checks.code_examples = 1; // Average 2+ code blocks per guide
  tier4_score += 1;
}

// Check 2: Clear Explanations (check average paragraph length - 50-200 chars is optimal)
let paragraph_lengths = [];
for (const file of guide_files) {
  const content = Read(file);
  const paragraphs = content.split('\n\n').filter(p => p.trim().length > 0 && !p.startsWith('#') && !p.startsWith('```'));
  for (const para of paragraphs) {
    paragraph_lengths.push(para.length);
  }
}
if (paragraph_lengths.length > 0) {
  const avg_length = paragraph_lengths.reduce((a, b) => a + b, 0) / paragraph_lengths.length;
  if (avg_length >= 50 && avg_length <= 300) {
    tier4_checks.clear_explanations = 1; // Optimal paragraph length
    tier4_score += 1;
  }
}

// Check 3: Step-by-Step Instructions (count numbered/bulleted lists)
let total_steps = 0;
for (const file of guide_files) {
  const content = Read(file);
  const numbered_steps = (content.match(/^\d+\./gm) || []).length;
  const bulleted_steps = (content.match(/^- /gm) || []).length;
  total_steps += numbered_steps + bulleted_steps;
}
if (total_steps >= guide_files.length * 5) {
  tier4_checks.step_by_step = 1; // Average 5+ steps per guide
  tier4_score += 1;
}

// Check 4: Complete API Documentation (examples per endpoint)
if (api_doc_files.length > 0) {
  let api_code_examples = 0;
  for (const file of api_doc_files) {
    const content = Read(file);
    api_code_examples += (content.match(/\`\`\`/g) || []).length / 2;
  }

  // Estimate endpoints from JUNO report
  const juno_report = Read(audit_report_path);
  const endpoint_match = juno_report.match(/API Endpoints?:\s*(\d+)/i);
  const endpoint_count = endpoint_match ? parseInt(endpoint_match[1]) : 10; // Default to 10 if not found

  if (api_code_examples >= endpoint_count * 0.5) {
    tier4_checks.api_examples = 1; // At least 50% of endpoints have examples
    tier4_score += 1;
  }
}

// Check 5: Professional Presentation (consistent heading structure)
let consistent_headings = true;
for (const file of all_docs) {
  const content = Read(file);
  const h1_count = (content.match(/^# /gm) || []).length;
  const h2_count = (content.match(/^## /gm) || []).length;

  // Each document should have exactly 1 H1 and at least 2 H2s
  if (h1_count !== 1 || h2_count < 2) {
    consistent_headings = false;
    break;
  }
}
if (consistent_headings) {
  tier4_checks.professional_presentation = 1;
  tier4_score += 1;
}

// Final tier4 score (max 5)
tier4_score = Math.min(5, tier4_score);

const total_score = tier1_score + tier2_score + tier3_score + tier4_score;

let grade = "";
if (total_score >= 95) grade = "Excellent (Production Ready)";
else if (total_score >= 85) grade = "Good (Minor improvements recommended)";
else if (total_score >= 70) grade = "Acceptable (Requires review and fixes)";
else grade = "Poor (Significant issues, re-generation recommended)";

// Build report
let report = `# Trinity Documentation Verification Report

**Generated:** ${new Date().toISOString()}
**JUNO Report:** ${audit_report_path}

---

## Executive Summary

**Overall Quality Score:** ${total_score}/100
**Grade:** ${grade}

**Completion:** ${tier1_passed ? "‚úÖ PASSED" : "‚ùå FAILED"}
**Content Quality:** ${tier2_critical_issues === 0 ? "‚úÖ PASSED" : "‚ùå FAILED"}
**Accuracy:** ${accuracy_warnings.length === 0 ? "‚úÖ PASSED" : `‚ö†Ô∏è ${accuracy_warnings.length} WARNINGS`}

---

## Score Breakdown (Rec 17: Detailed Scoring)

### Tier 1: Completion (${tier1_score}/40)

**Scoring Formula:** All files created = 40 points | Any file missing = 0 points

${tier1_passed ? "‚úÖ All expected files created" : "‚ùå Some files missing"}

**File Checklist:**
- Diagrams: ${diagram_files.length}/${expected_diagrams} ${diagrams_ok ? "‚úÖ" : "‚ùå"}
  ${diagram_files.map(f => `  - ${f}`).join('\n')}
- Guides: ${guide_files.length}/${expected_guides} ${guides_ok ? "‚úÖ" : "‚ùå"}
  ${guide_files.map(f => `  - ${f}`).join('\n')}
- API Docs: ${api_doc_files.length}/${expected_api_docs} ${api_docs_ok ? "‚úÖ" : "‚ùå"}
  ${api_doc_files.map(f => `  - ${f}`).join('\n')}
- Config: ${config_ok ? "1/1" : "0/1"} ${config_ok ? "‚úÖ" : "‚ùå"}
  ${config_ok ? "  - .env.example" : "  - (missing)"}

**Total Files Created:** ${all_docs.length + (config_ok ? 1 : 0)}

**Result:** ${tier1_score === 40 ? "PASSED - All files present" : "FAILED - Missing files detected"}

### Tier 2: Content Quality (${tier2_score}/40)

**Scoring Formula:** No critical issues = 40 points | Any critical issue = 0 points (fail-fast)

${tier2_critical_issues === 0 ? "‚úÖ All quality checks passed" : `‚ùå ${tier2_critical_issues} critical issues`}

**Detailed Results:**
1. **Template Placeholders** (CRITICAL): ${verification_issues.template_placeholders.length} ${verification_issues.template_placeholders.length === 0 ? "‚úÖ PASS" : "‚ùå FAIL"}
   - Requirement: Zero placeholders ({{VARIABLE}}) in output
   - Found: ${verification_issues.template_placeholders.length} instances
   ${verification_issues.template_placeholders.length > 0 ? verification_issues.template_placeholders.map(i => `   - ${i.file}: ${i.placeholder}`).join('\n') : ""}

2. **Internal Link Validation** (CRITICAL): ${verification_issues.broken_links.length} ${verification_issues.broken_links.length === 0 ? "‚úÖ PASS" : "‚ùå FAIL"}
   - Requirement: All links must reference existing files
   - Found: ${verification_issues.broken_links.length} broken links
   ${verification_issues.broken_links.length > 0 ? verification_issues.broken_links.map(i => `   - ${i.file}: [${i.link_text}](${i.target})`).join('\n') : ""}

3. **Mermaid Syntax Validation** (CRITICAL): ${verification_issues.mermaid_errors.length} ${verification_issues.mermaid_errors.length === 0 ? "‚úÖ PASS" : "‚ùå FAIL"}
   - Requirement: Valid Mermaid syntax with proper diagram types
   - Found: ${verification_issues.mermaid_errors.length} syntax errors
   ${verification_issues.mermaid_errors.length > 0 ? verification_issues.mermaid_errors.map(i => `   - ${i.file}: ${i.error}`).join('\n') : ""}

4. **Stub Content Detection** (CRITICAL): ${verification_issues.stub_content ? verification_issues.stub_content.length : 0} ${(verification_issues.stub_content ? verification_issues.stub_content.length : 0) === 0 ? "‚úÖ PASS" : "‚ùå FAIL"}
   - Requirement: No "coming soon", "TODO", or stub content
   - Found: ${verification_issues.stub_content ? verification_issues.stub_content.length : 0} instances
   ${verification_issues.stub_content && verification_issues.stub_content.length > 0 ? verification_issues.stub_content.map(i => `   - ${i.file}: "${i.pattern}"`).join('\n') : ""}

5. **Content Length** (WARNING): ${verification_issues.short_content.length} ${verification_issues.short_content.length === 0 ? "‚úÖ PASS" : "‚ö†Ô∏è WARN"}
   - Requirement: Substantial content (diagrams ‚â•100 chars, docs ‚â•200 chars)
   - Found: ${verification_issues.short_content.length} short files (non-blocking)

**Result:** ${tier2_score === 40 ? "PASSED - No critical issues" : "FAILED - Critical quality issues detected"}

### Tier 3: Accuracy (${tier3_score}/15)

**Scoring Formula:** 15 points base | -5 per HIGH severity | -3 per MEDIUM | -1 per LOW (min 0)

${accuracy_warnings.length === 0 ? "‚úÖ No inaccuracies detected" : `‚ö†Ô∏è ${accuracy_warnings.length} warnings (non-blocking)`}

**Scoring Breakdown:**
- Base Score: 15 points
${accuracy_warnings.length > 0 ? accuracy_warnings.map(w => `- Deduction: -${w.severity === 'HIGH' ? 5 : w.severity === 'MEDIUM' ? 3 : 1} (${w.severity}) ${w.category}: ${w.issue}`).join('\n') : "- No deductions"}
- **Final Score: ${tier3_score}/15**

**Warnings:**
${accuracy_warnings.length > 0 ? accuracy_warnings.map(w => `- [${w.severity}] ${w.category}: ${w.issue}`).join('\n') : "None"}

**Result:** ${tier3_score >= 12 ? "GOOD" : tier3_score >= 8 ? "ACCEPTABLE" : "NEEDS REVIEW"}

### Tier 4: Excellence (${tier4_score}/5) - Rec 23: Automated Readability Scoring

**Scoring Criteria (Automated):**
1. **Comprehensive Code Examples** (1 point): ${tier4_checks.code_examples ? "‚úÖ PASS" : "‚ùå FAIL"}
   - Requirement: Average 2+ code blocks per guide
   - Found: ${(total_code_blocks / Math.max(1, guide_files.length)).toFixed(1)} blocks per guide
   - Result: ${tier4_checks.code_examples ? "+1 point" : "+0 points"}

2. **Clear Explanations** (1 point): ${tier4_checks.clear_explanations ? "‚úÖ PASS" : "‚ùå FAIL"}
   - Requirement: Optimal paragraph length (50-300 chars)
   - Average: ${paragraph_lengths.length > 0 ? (paragraph_lengths.reduce((a, b) => a + b, 0) / paragraph_lengths.length).toFixed(0) + " chars" : "N/A"}
   - Result: ${tier4_checks.clear_explanations ? "+1 point" : "+0 points"}

3. **Step-by-Step Instructions** (1 point): ${tier4_checks.step_by_step ? "‚úÖ PASS" : "‚ùå FAIL"}
   - Requirement: Average 5+ steps/lists per guide
   - Found: ${(total_steps / Math.max(1, guide_files.length)).toFixed(1)} steps per guide
   - Result: ${tier4_checks.step_by_step ? "+1 point" : "+0 points"}

4. **Complete API Documentation** (1 point): ${tier4_checks.api_examples ? "‚úÖ PASS" : "‚ùå FAIL"}
   - Requirement: ‚â•50% of endpoints have code examples
   - Found: ${api_doc_files.length > 0 ? (api_code_examples + " examples for ~" + endpoint_count + " endpoints") : "No API docs"}
   - Result: ${tier4_checks.api_examples ? "+1 point" : "+0 points"}

5. **Professional Presentation** (1 point): ${tier4_checks.professional_presentation ? "‚úÖ PASS" : "‚ùå FAIL"}
   - Requirement: Consistent heading structure (1 H1, 2+ H2s per doc)
   - Result: ${tier4_checks.professional_presentation ? "‚úÖ Consistent" : "‚ùå Inconsistent"}
   - Result: ${tier4_checks.professional_presentation ? "+1 point" : "+0 points"}

**Final Score:** ${tier4_score}/5 points

**Result:** ${tier4_score === 5 ? "EXCELLENT" : tier4_score >= 3 ? "GOOD" : "NEEDS IMPROVEMENT"}

---

## Files Created

### Architecture Diagrams (${diagram_files.length})

${diagram_files.map(f => `- ${f}`).join('\n')}

### Developer Guides (${guide_files.length})

${guide_files.map(f => `- ${f}`).join('\n')}

### API Documentation (${api_doc_files.length})

${api_doc_files.map(f => `- ${f}`).join('\n')}

### Configuration Files (${config_ok ? 1 : 0})

${config_ok ? "- .env.example" : "- (none created)"}
- README.md (updated)

---

## Performance Metrics (Rec 15)

### Execution Times

- **JUNO Audit**: ${((global.trinity_docs_session.performance_metrics.juno_end - global.trinity_docs_session.performance_metrics.juno_start) / 1000).toFixed(2)}s
- **APO Parallel Execution**: ${((global.trinity_docs_session.performance_metrics.apo_end - global.trinity_docs_session.performance_metrics.apo_start) / 1000).toFixed(2)}s
  - APO-1 (Diagrams): ${apo1_time}s (estimated)
  - APO-2 (Guides): ${apo2_time}s (estimated)
  - APO-3 (Config): ${apo3_time}s (estimated)
- **Verification**: ${((Date.now() - global.trinity_docs_session.performance_metrics.verification_start) / 1000).toFixed(2)}s
  - Tier 1 (Completion): ${tier1_time}s
  - Tier 2 (Content Quality): ${tier2_time}s
  - Tier 3 (Accuracy): ${tier3_time}s
  - Tier 4 (Excellence): ${tier4_time}s
- **Total Execution**: ${((Date.now() - global.trinity_docs_session.performance_metrics.total_start) / 1000).toFixed(2)}s

### Efficiency Metrics

- **Parallel Efficiency**: ${(((global.trinity_docs_session.performance_metrics.apo_end - global.trinity_docs_session.performance_metrics.apo_start) / (apo1_time + apo2_time + apo3_time)) * 100).toFixed(1)}% (3x theoretical speedup: ${((apo1_time + apo2_time + apo3_time) / (global.trinity_docs_session.performance_metrics.apo_end - global.trinity_docs_session.performance_metrics.apo_start)).toFixed(2)}x)
- **Throughput**: ${(all_docs.length / ((Date.now() - global.trinity_docs_session.performance_metrics.total_start) / 1000)).toFixed(2)} files/second
- **JUNO Analysis Rate**: ${juno_files_analyzed && juno_files_analyzed !== "Unknown" ? (juno_files_analyzed / ((global.trinity_docs_session.performance_metrics.juno_end - global.trinity_docs_session.performance_metrics.juno_start) / 1000)).toFixed(2) + " files/second" : "N/A"}

### Resource Usage

- **Total Files Generated**: ${all_docs.length}
- **Total Documentation Size**: ${(all_docs.reduce((acc, f) => acc + Read(f).length, 0) / 1024).toFixed(2)} KB
- **Average File Size**: ${(all_docs.reduce((acc, f) => acc + Read(f).length, 0) / all_docs.length / 1024).toFixed(2)} KB
- **JUNO Report Size**: ${(Read(audit_report_path).length / 1024).toFixed(2)} KB

---

## Recommendations

${total_score >= 95 ? "‚úÖ Documentation is production-ready. No action required." : ""}
${total_score >= 85 && total_score < 95 ? "‚ö†Ô∏è Documentation is good but has minor issues. Review warnings above." : ""}
${total_score >= 70 && total_score < 85 ? "‚ö†Ô∏è Documentation requires review and fixes before deployment." : ""}
${total_score < 70 ? "‚ùå Documentation quality is insufficient. Re-generation recommended." : ""}

${accuracy_warnings.length > 0 ? "\n### Action Items:\n\n" + accuracy_warnings.map((w, i) => `${i + 1}. ${w.category}: ${w.issue}`).join('\n') : ""}

---

**Report Generated by:** Trinity Documentation Generator v2.0.9
**Architecture:** Multi-agent orchestration (JUNO + 3 parallel APOs)
`;

Write(report_path, report);

LOG: `‚úÖ Verification report saved: ${report_path}`;
LOG: "";

global.trinity_docs_session.verification = {
  score: total_score,
  grade: grade,
  report_path: report_path
};
```

---

## Phase 4: Completion Report

```javascript
// Track final performance
global.trinity_docs_session.performance_metrics.verification_end = Date.now();
global.trinity_docs_session.performance_metrics.total_end = Date.now();

const perf = global.trinity_docs_session.performance_metrics;

LOG: "=== TRINITY DOCUMENTATION GENERATION COMPLETE ===";
LOG: "";
LOG: "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó";
LOG: "‚ïë                   üéâ SUCCESS                               ‚ïë";
LOG: "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù";
LOG: "";
LOG: "Quality Score: " + global.trinity_docs_session.verification.score + "/100";
LOG: "Grade: " + global.trinity_docs_session.verification.grade;
LOG: "";
LOG: "Documentation Summary:";
LOG: `  Architecture Diagrams: ${diagram_files.length} files`;
LOG: `  Developer Guides: ${guide_files.length} files`;
LOG: `  API Documentation: ${api_doc_files.length} files`;
LOG: `  Configuration Files: ${config_ok ? 1 : 0} files`;
LOG: `  Total: ${diagram_files.length + guide_files.length + api_doc_files.length + (config_ok ? 1 : 0)} files`;
LOG: "";
LOG: "üìÅ Documentation Structure:";
LOG: "  docs/";
LOG: "  ‚îú‚îÄ‚îÄ images/        (Architecture diagrams)";
LOG: "  ‚îú‚îÄ‚îÄ guides/        (Developer guides)";
LOG: "  ‚îú‚îÄ‚îÄ api/           (API reference)";
LOG: "  ‚îî‚îÄ‚îÄ README.md      (Documentation home)";
LOG: "";
LOG: "‚è±Ô∏è Performance Metrics:";
LOG: `  JUNO Audit: ${((perf.juno_end - perf.juno_start) / 1000).toFixed(2)}s`;
LOG: `  APO Parallel Execution: ${((perf.apo_end - perf.apo_start) / 1000).toFixed(2)}s`;
LOG: `  Verification: ${((perf.verification_end - perf.verification_start) / 1000).toFixed(2)}s`;
LOG: `  Total Time: ${((perf.total_end - perf.total_start) / 1000).toFixed(2)}s`;
LOG: "";
LOG: "üöÄ Next Steps:";
LOG: "  1. Review generated documentation in docs/ directory";
LOG: "  2. Verify Mermaid diagrams render correctly";
LOG: "  3. Check API documentation accuracy";
LOG: "  4. Update .env.example with project-specific values if needed";
LOG: "";
LOG: "üìä Reports:";
LOG: `  Audit Report: ${audit_report_path}`;
LOG: `  Verification Report: ${global.trinity_docs_session.verification.report_path}`;
LOG: "";
LOG: "‚ú® Documentation generated using Trinity Method v2.0.9 (Orchestration Architecture)";
LOG: "";
```

---

## Architecture Notes

### Why This Approach Works

**Context Isolation:**
- JUNO reads codebase (focused analysis task)
- Each APO reads <100 lines (their specific section from report)
- No single agent reads massive context

**Parallel Execution:**
- APO-1, APO-2, APO-3 run simultaneously
- 3x faster than sequential execution
- Independent sections prevent blocking

**Quality Gates:**
- JUNO self-validation ensures report completeness (Rec 3)
- JUNO report validation catches incomplete audits (Rec 1)
- APO self-validation ensures file creation and quality (Rec 6)
- Enhanced verification enforces content quality (Rec 7)
- 4-tier success criteria with objective scoring (Rec 9)

**Resilience:**
- APO fallback mechanisms handle incomplete JUNO reports (Rec 4)
- Error handling protocol prevents silent failures (Rec 5)
- README link validation prevents broken references (Rec 8)

**Intelligence:**
- Testing framework detection prevents inaccuracies (Rec 11)
- Component discovery ensures accurate diagrams (Rec 12)
- Enhanced JUNO prompt clarity improves report quality (Rec 2)

**Observability:**
- Performance tracking across all phases (Rec 10)
- Verification report with quality score
- Clear ABORT vs WARN vs LOG distinction

### Comparison to Previous Architecture

| Metric | v2.0.x (Sequential) | v3.0.0 (Orchestrated) | v3.1 (Enhanced) |
|--------|---------------------|------------------------|-----------------|
| Command Size | 4,656 lines | 888 lines | ~1,800 lines |
| Largest Context | 4,656 lines (APO) | ~300 lines (JUNO) | ~400 lines (APO-1) |
| Execution | Sequential | Parallel (3x) | Parallel (3x) |
| Quality Gates | After generation | JUNO validation | JUNO + APO + Verification |
| Failure Mode | Silent skips | File count check | Content quality ABORT |
| Success Rate | 0% (v2.0.8 test) | 94% (v3.0.0 test) | 98-100% (expected) |
| Fallback | None | Undocumented | Documented (Phase 1.5) |
| Self-Validation | None | None | JUNO + 3 APOs |
| Link Validation | None | None | APO-3 + Verification |
| Accuracy Checks | None | None | Verification Tier 3 |

### Quality Improvements (v3.1)

**Issues Resolved:**
1. ‚úÖ JUNO incomplete reports (Rec 1: validation with ABORT/WARN)
2. ‚úÖ Broken README links (Rec 8: comprehensive link validation)
3. ‚úÖ Template placeholders (Rec 7: verification with ABORT)
4. ‚úÖ Invalid Mermaid syntax (Rec 7: validation with ABORT)
5. ‚úÖ Testing framework inaccuracies (Rec 11: detection in JUNO)
6. ‚úÖ Non-existent components (Rec 12: discovery in JUNO)

**New Capabilities:**
1. ‚úÖ Objective quality scoring (0-100) (Rec 9)
2. ‚úÖ Performance tracking across phases (Rec 10)
3. ‚úÖ APO fallback architecture (Rec 4)
4. ‚úÖ Error handling protocol (Rec 5)
5. ‚úÖ Self-validation at all levels (Rec 3, 6)
6. ‚úÖ Enhanced verification with 4 tiers (Rec 7)

---

## Error Handling

### If Verification Fails

**Tier 1 Failure (Completion):**
- ABORT command immediately
- Review JUNO's audit report (lists what should exist)
- Review APO execution logs (shows what was attempted)
- Check for APO errors or exceptions
- Re-run command if transient failure

**Tier 2 Failure (Content Quality):**
- ABORT command immediately
- Review specific issues:
  - Template placeholders: APO didn't replace variables
  - Broken links: APO-3 created links to non-existent files
  - Mermaid errors: APO-1 generated invalid syntax
- Fix underlying APO issue or JUNO report incompleteness
- Re-run command

**Tier 3 Warnings (Accuracy):**
- Command completes successfully
- Review warnings in verification report
- Manually fix inaccuracies if needed
- No re-run required

### If JUNO Fails

**Incomplete Report:**
- JUNO validation catches this (Rec 1)
- Warnings logged, APO fallback activates
- Documentation still generated (may be lower quality)

**No Report Created:**
- Command ABORTs in Phase 1
- Check codebase structure (package.json exists?)
- Verify framework detection logic
- Check JUNO agent availability

---
