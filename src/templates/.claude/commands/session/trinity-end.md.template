# Trinity End

**Command:** `/session:trinity-end`
**Purpose:** End session and archive work to trinity/archive/
**Architecture:** ALY session summary → Work archival → Documentation update
**Trinity Version:** 2.0.9
**Last Updated:** 2026-01-12

---

End current Trinity Method session and prepare for commit.

**Context:** User is finished with current task and ready to commit, push, or move to next work.

**Process:**
1. **ALY (CTO)** archives session work:

   **STRICT ARCHIVING PROTOCOL:**

   a. **Archive Completed Work Orders:**
      - Read all files from `trinity/sessions/` matching `WO-*.md`
      - Move each to `trinity/archive/work-orders/YYYY-MM-DD/`
      - These were moved to sessions/ after completion per work order template

   b. **Archive Completed Investigations:**
      - Read all files from `trinity/sessions/` matching `INV-*.md`
      - Move each to `trinity/archive/investigations/YYYY-MM-DD/`
      - These were moved to sessions/ after completion per investigation template

   c. **Archive ALL Reports:**
      - Move ALL files from `trinity/reports/` to `trinity/archive/reports/YYYY-MM-DD/`
      - This includes:
        - Implementation completion reports
        - Investigation findings reports
        - JUNO audit reports
        - Any other session reports
      - **NO EXCEPTIONS:** Every file in reports/ must be archived

   d. **Archive Session Files:**
      - Move ALL remaining files from `trinity/sessions/` to `trinity/archive/sessions/YYYY-MM-DD/`
      - Create session summary document in `trinity/archive/sessions/YYYY-MM-DD/SESSION-SUMMARY-{date}.md`

   e. **Verify Clean Slate:**
      - **CRITICAL:** After archiving, `trinity/sessions/` MUST be empty
      - **CRITICAL:** After archiving, `trinity/reports/` MUST be empty
      - If any files remain, archive them or report error
      - Next session MUST start with completely empty sessions/ and reports/ folders

   **Archive Structure:**
   ```
   trinity/archive/
   ├── work-orders/YYYY-MM-DD/
   │   ├── WO-001-*.md
   │   ├── WO-002-*.md
   │   └── ...
   ├── investigations/YYYY-MM-DD/
   │   ├── INV-001-*.md
   │   ├── INV-002-*.md
   │   └── ...
   ├── reports/YYYY-MM-DD/
   │   ├── WO-001-IMPLEMENTATION-COMPLETE-*.md
   │   ├── AUDIT-WO-001-*.md
   │   ├── INV-001-findings-*.md
   │   └── ...
   └── sessions/YYYY-MM-DD/
       ├── SESSION-SUMMARY-{date}.md
       └── [any other session files]
   ```

   **Important Notes:**
   - Keep ONLY active/in-progress work orders in `trinity/work-orders/`
   - Keep ONLY active/in-progress investigations in `trinity/investigations/`
   - Do NOT archive incomplete work
   - Completed work is identified by presence in `trinity/sessions/` folder
   - All reports are archived regardless of status

2. **ALY analyzes session events:**
   - Review all work completed during session
   - Identify patterns and learnings
   - Update trinity/knowledge-base/ARCHITECTURE.md with architectural changes
   - Update trinity/knowledge-base/ISSUES.md with new known issues
   - Update trinity/knowledge-base/To-do.md with next tasks
   - Update trinity/knowledge-base/Technical-Debt.md with new debt

3. **Clean workspace:**
   - Verify trinity/work-orders/ contains only active work
   - Verify trinity/investigations/ contains only active investigations
   - Verify trinity/reports/ is empty
   - Verify trinity/sessions/ is empty
   - Ready for next session

4. **Git commit instructions:**
   After archiving, provide user with commit checklist:

   **For Trinity Method SDK project:**
   - Update version in package.json (semantic versioning)
   - Run `npm run build` to compile changes
   - Run `npm pack` to create tarball
   - Update CHANGELOG.md with changes
   - Git commit with descriptive message
   - Git push to repository

   **For client projects using Trinity:**
   - Review git status for modified files
   - Stage changes: `git add .`
   - Commit with message describing work completed
   - Push to repository: `git push`

**Outcome:**
- All completed work properly archived with timestamp
- Active/in-progress work remains in working directories
- Trinity documents updated with session learnings
- Workspace clean and ready for git operations
- User has clear instructions for version updates and commits

**Note:** Run this before committing your work.

---

## When to Use /trinity-end

### ✅ Use When:

1. **Work Session Complete**
   - All work orders closed
   - All commits pushed
   - Ready to stop working

2. **Major Milestone Reached**
   - Feature complete and merged
   - Sprint completed
   - Release deployed

3. **Context Cleanup Needed**
   - Long session (>4 hours)
   - Multiple work orders completed
   - Knowledge base needs updating

### ❌ Don't Use When:

1. **Mid-Task**
   - Work order still in progress
   - Uncommitted changes
   - Tests failing

2. **Just Pausing**
   - Taking a break (keep context)
   - Switching tasks temporarily
   - Waiting for review

**Instead Use**: `/trinity-continue` when resuming work

---

## Session Summary Example

```markdown
# Session Summary - 2025-12-18

**Duration**: 4 hours 30 minutes
**Work Orders Completed**: 2 (WO-042, WO-043)
**Commits**: 7 commits pushed to main

## Accomplishments

### WO-042: JWT Refresh Token Implementation ✅
- Implemented secure refresh token rotation
- Added HttpOnly cookie support
- 87% test coverage (exceeds 80% threshold)
- All BAS quality gates passed

**Files Changed**: 4 files (service, middleware, types, tests)
**Lines**: +234 additions, -12 deletions

### WO-043: User Profile Editing ✅
- Added profile update endpoint
- Validation for all fields
- Integration tests complete
- Documentation updated

**Files Changed**: 3 files (controller, service, tests)
**Lines**: +156 additions, -8 deletions

## Knowledge Base Updates

**ARCHITECTURE.md**:
- Added OAuth2 refresh token flow diagram
- Documented token rotation strategy

**ISSUES.md**:
- Closed: #42 (JWT refresh), #45 (profile editing)
- Added: #48 (rate limiting for refresh endpoint)

**Technical-Debt.md**:
- Added: Refactor auth service (split into 2 files)
- Resolved: Email validation duplication

## Metrics

- **Velocity**: 2 work orders / 4.5 hours = 0.44 WO/hour
- **Test Coverage**: Maintained 85% average
- **Build Status**: All builds passed
- **Code Quality**: Zero linting errors

## Next Session

**Planned Work Orders**:
- WO-048: Rate limiting implementation
- WO-049: Auth service refactoring

**Estimated Time**: 3-4 hours

---

**Session closed at**: 2025-12-18 18:30
**Knowledge base**: Updated
**All changes**: Committed and pushed
**Status**: ✅ Clean slate for next session
```

---

---

## Knowledge Base Update Checklist

Before ending session, ALY updates living documentation based on session work:

### Phase 1: Core Document Updates (Required)

Update these documents based on what changed during the session:

#### ARCHITECTURE.md
- [ ] **New Components**: Add to Component Architecture table
- [ ] **Technology Changes**: Update Technology Profile (framework versions, new tools)
- [ ] **API Changes**: Update API endpoints or patterns
- [ ] **Integration Changes**: Add/update External Integrations
- [ ] **Performance Changes**: Update baselines if optimization occurred
- [ ] **Architectural Decisions**: Add to Technical Decisions Log
- [ ] **Cross-References**: Verify links to ISSUES.md, Technical-Debt.md still valid
- [ ] **Last Updated**: Set to current date

#### ISSUES.md
- [ ] **Close Resolved Issues**: Mark issues fixed during session as resolved
- [ ] **Add New Issues**: Document new bugs/patterns discovered
- [ ] **Update Patterns**: Add new recurring patterns discovered
- [ ] **Update Metrics**: Refresh Issue Resolution Metrics
- [ ] **Investigation Links**: Link to investigations completed this session
- [ ] **Cross-References**: Ensure links to Technical-Debt.md, ARCHITECTURE.md accurate
- [ ] **Last Updated**: Set to current date

#### To-do.md
- [ ] **Remove Completed**: Delete or mark complete tasks finished during session
- [ ] **Add New Tasks**: Add tasks identified during development
- [ ] **Update Priorities**: Re-prioritize based on new information
- [ ] **Update Sprint Planning**: Refresh current sprint status
- [ ] **Update Backlog**: Add items discovered during session
- [ ] **Velocity Metrics**: Calculate session velocity
- [ ] **Last Updated**: Set to current date

#### Technical-Debt.md
- [ ] **Add New Debt**: Document TODOs/FIXMEs/HACKs added during session
- [ ] **Resolve Debt**: Remove items paid down during session
- [ ] **Update Metrics**: Recalculate debt metrics (TODO count, file complexity, coverage)
- [ ] **Add Patterns**: Document new debt patterns discovered
- [ ] **Update Trends**: Refresh Session Comparison metrics
- [ ] **ROI Analysis**: Update debt reduction plan based on session learnings
- [ ] **Cross-References**: Ensure links to ISSUES.md patterns are current
- [ ] **Last Updated**: Set to current date

### Phase 2: Standards Updates (If Changed)

Only update these if the session introduced new patterns or standards:

#### CODING-PRINCIPLES.md
- [ ] **New Patterns**: Add new good/bad examples discovered
- [ ] **Refactoring Strategies**: Document new refactoring patterns used
- [ ] **Framework Changes**: Update if framework version changed standards
- [ ] **Last Updated**: Set to current date (only if modified)

#### TESTING-PRINCIPLES.md
- [ ] **New Test Patterns**: Add testing patterns discovered
- [ ] **Coverage Updates**: Update coverage targets if changed
- [ ] **Testing Strategies**: Document new mocking/stubbing patterns
- [ ] **Last Updated**: Set to current date (only if modified)

#### AI-DEVELOPMENT-GUIDE.md
- [ ] **Workflow Improvements**: Update if Trinity workflows changed
- [ ] **Scale Examples**: Add new scale examples if discovered
- [ ] **Agent Protocols**: Update if agent communication patterns changed
- [ ] **Last Updated**: Set to current date (only if modified)

#### Trinity.md
- [ ] **Protocol Updates**: Document protocol changes or improvements
- [ ] **Performance Baselines**: Update if project baselines changed
- [ ] **Session Workflow**: Update if workflow process improved
- [ ] **Success Metrics**: Add metrics from completed session
- [ ] **Last Updated**: Set to current date (only if modified)

#### DOCUMENTATION-CRITERIA.md
- [ ] **Criteria Changes**: Update if documentation standards evolved
- [ ] **Last Updated**: Set to current date (only if modified)

### Phase 3: Quality Verification

After all updates, verify documentation integrity:

#### Content Quality
- [ ] All updated files have meaningful changes (not just timestamp)
- [ ] No placeholder syntax `{{VARIABLE}}` introduced during updates
- [ ] Metrics use real project values (not example numbers)
- [ ] Code examples match project's actual framework/language

#### Cross-Reference Integrity
- [ ] Links between documents still work (no broken references)
- [ ] When updating ARCHITECTURE → checked if ISSUES/Technical-Debt need updates
- [ ] When adding ISSUES → added related Technical-Debt items if applicable
- [ ] When closing To-do tasks → verified linked ISSUES closed

#### Consistency Checks
- [ ] Timestamps updated ({{CURRENT_DATE}} replaced with actual date)
- [ ] Project name consistent across all files
- [ ] Framework/technology names consistent
- [ ] Component names match across ARCHITECTURE/ISSUES/Technical-Debt

#### Completeness Validation
- [ ] New components documented in ARCHITECTURE
- [ ] New issues documented in ISSUES.md
- [ ] New technical debt tracked in Technical-Debt.md
- [ ] Completed work removed from To-do.md
- [ ] Session learnings captured somewhere (not lost)

### Update Guidelines

**For each document updated**:
1. Open the file
2. Use the document's "When to Update" section as guide (see knowledge-base templates)
3. Make specific, meaningful changes (don't just change timestamps)
4. Verify cross-references to other documents
5. Keep placeholders for future sessions (don't replace with generic examples)

**When in doubt**:
- If something changed → document it
- If nothing changed → don't update (stale timestamp is okay)
- If unsure → reference the document's "When to Update This Document" section

**Cross-Document Update Scenarios**:

**Scenario: Added New Component**
→ Update ARCHITECTURE.md (component table)
→ Update To-do.md (add testing/documentation tasks)
→ Check ISSUES.md (any known issues with this type of component?)

**Scenario: Fixed Bug**
→ Update ISSUES.md (close issue)
→ Update Technical-Debt.md (if fix paid down debt)
→ Update To-do.md (mark task complete)

**Scenario: Added TODO/FIXME**
→ Update Technical-Debt.md (increment TODO count)
→ Update To-do.md (add task to address it)

**Scenario: Refactored Large File**
→ Update Technical-Debt.md (reduce file complexity metrics)
→ Update ARCHITECTURE.md (if component structure changed)
→ Update ISSUES.md (close related refactoring issues)

### Session Summary Integration

After knowledge base updates, ALY creates session summary including:
- **Documents Updated**: List which knowledge-base files changed
- **Key Changes**: Summarize what was added/removed/modified
- **Cross-References**: Note which documents reference each other
- **Metrics Delta**: Before/after metrics for Technical-Debt.md

Example:
```markdown
## Knowledge Base Updates

**ARCHITECTURE.md**:
- Added: OAuth2 refresh token flow to API Architecture
- Updated: Authentication section with refresh token rotation

**ISSUES.md**:
- Closed: ISS-042 (JWT refresh implementation)
- Added: ISS-048 (Rate limiting pattern for auth endpoints)

**Technical-Debt.md**:
- Resolved: Email validation duplication (was in 3 files)
- Added: Auth service refactoring (split into 2 files)
- Metrics: TODO count decreased 5 → 3, File complexity improved

**To-do.md**:
- Completed: T-042 (Implement JWT refresh)
- Added: T-048 (Rate limiting), T-049 (Auth refactoring)

**Cross-References Updated**:
- ARCHITECTURE.md ↔ ISSUES.md (linked refresh token pattern)
- ISSUES.md ↔ Technical-Debt.md (linked auth refactoring debt)
- To-do.md ↔ ISSUES.md (linked rate limiting task to issue)
```

---
