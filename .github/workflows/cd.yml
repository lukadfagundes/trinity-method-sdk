# Trinity Method SDK v2.0.0 - Continuous Deployment Pipeline
# EIN (CI/CD Specialist) - Automated deployment to npm registry
# Triggered on version tags on main branch (v2.0.0, v2.0.1, etc.)

name: Trinity CD Pipeline

on:
  push:
    branches:
      - main
      - dev
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 2.0.1)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (do not actually publish)'
        required: false
        type: boolean
        default: false

jobs:
  # =============================================
  # Pre-Deployment Validation
  # =============================================
  validate:
    name: Pre-Deployment Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Validate version tag
        if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.version != ''
        run: |
          echo "Validating version tag..."

          # Extract version from tag or workflow input
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi

          echo "Target version: $VERSION"

          # Check version matches package.json
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "package.json version: $PACKAGE_VERSION"

          if [ "$VERSION" != "$PACKAGE_VERSION" ]; then
            echo "ERROR: Version mismatch"
            echo "  Tag version: $VERSION"
            echo "  package.json version: $PACKAGE_VERSION"
            exit 1
          fi

          echo "Version validation successful"

      - name: Check CHANGELOG
        if: startsWith(github.ref, 'refs/tags/') || github.event.inputs.version != ''
        run: |
          echo "Checking CHANGELOG.md..."

          if [ ! -f "CHANGELOG.md" ]; then
            echo "WARNING: CHANGELOG.md not found"
          else
            # Extract version from tag
            if [ -n "${{ github.event.inputs.version }}" ]; then
              VERSION="${{ github.event.inputs.version }}"
            else
              VERSION="${GITHUB_REF#refs/tags/v}"
            fi

            if ! grep -q "## \[$VERSION\]" CHANGELOG.md; then
              echo "WARNING: CHANGELOG.md missing entry for version $VERSION"
            else
              echo "CHANGELOG.md contains version $VERSION"
            fi
          fi

      - name: Run all tests
        run: npm test

      - name: Verify coverage
        run: npm run test:coverage

  # =============================================
  # Build Release Artifacts
  # =============================================
  build:
    name: Build Release
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Verify build artifacts
        run: |
          echo "Verifying build artifacts for release..."

          # Check dist directory
          if [ ! -d "dist" ]; then
            echo "ERROR: dist directory not found"
            exit 1
          fi

          # Check CLI
          if [ ! -f "dist/cli/index.js" ]; then
            echo "ERROR: CLI entry point not found"
            exit 1
          fi

          # Check templates
          if [ ! -d "dist/templates" ]; then
            echo "ERROR: Templates not found in dist"
            exit 1
          fi

          # Count agent templates
          agent_count=$(find dist/templates/agents -name "*.md.template" | wc -l)
          echo "Agent templates: $agent_count"

          if [ "$agent_count" -lt 19 ]; then
            echo "ERROR: Expected 19 agent templates, found $agent_count"
            exit 1
          fi

          # Count slash commands
          cmd_count=$(find dist/templates/shared/claude-commands -name "*.md.template" | wc -l)
          echo "Slash command templates: $cmd_count"

          if [ "$cmd_count" -lt 19 ]; then
            echo "ERROR: Expected 19+ slash commands, found $cmd_count"
            exit 1
          fi

          echo "Build artifacts verified successfully"

      - name: Create release tarball
        run: npm pack

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            dist/
            trinity-method-sdk-*.tgz
          retention-days: 90

  # =============================================
  # Publish to npm Registry
  # =============================================
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: build
    # Only publish to npm when pushing to main branch or version tags (skip dev branch)
    if: github.ref != 'refs/heads/dev'
    environment:
      name: production
      url: https://www.npmjs.com/package/trinity-method-sdk
    permissions:
      id-token: write # Required for OIDC authentication with npm
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Publish to npm (dry-run)
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "DRY RUN: Would publish to npm"
          npm publish --dry-run
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish to npm
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "Publishing to npm registry..."
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify publication
        if: github.event.inputs.dry_run != 'true'
        run: |
          echo "Verifying npm publication..."

          # Extract version
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi

          # Wait for npm registry to update
          sleep 30

          # Check if package is available
          npm view trinity-method-sdk@$VERSION version || {
            echo "WARNING: Package not yet visible on npm registry"
            echo "This may take a few minutes to propagate"
          }

          echo "Publication verification complete"

  # =============================================
  # Create GitHub Release
  # =============================================
  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: publish
    if: github.event.inputs.dry_run != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts

      - name: Extract release notes
        id: release_notes
        run: |
          echo "Extracting release notes from CHANGELOG.md..."

          # Extract version
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi

          # Extract release notes for this version
          if [ -f "CHANGELOG.md" ]; then
            # Extract section between this version and the next
            awk "/## \[$VERSION\]/,/## \[.*\]/{print}" CHANGELOG.md | head -n -1 > release_notes.txt

            # If empty, use a default message
            if [ ! -s release_notes.txt ]; then
              echo "Release $VERSION of Trinity Method SDK" > release_notes.txt
            fi
          else
            echo "Release $VERSION of Trinity Method SDK" > release_notes.txt
          fi

          cat release_notes.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.txt
          files: |
            trinity-method-sdk-*.tgz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =============================================
  # Deployment Success Notification
  # =============================================
  notify:
    name: Deployment Success
    runs-on: ubuntu-latest
    needs: [publish, github-release]
    if: always()

    steps:
      - name: Deployment summary
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "   Trinity Method SDK - Deployment Complete"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""

          # Extract version
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi

          echo "Version:           $VERSION"
          echo "Validation:        ${{ needs.publish.result }}"
          echo "npm Publication:   ${{ needs.publish.result }}"
          echo "GitHub Release:    ${{ needs.github-release.result }}"
          echo ""
          echo "Package URL:       https://www.npmjs.com/package/trinity-method-sdk"
          echo "Install Command:   npm install -g trinity-method-sdk@$VERSION"
          echo ""
          echo "Trinity Components Deployed:"
          echo "  19 AI Agent Templates"
          echo "  19+ Slash Commands"
          echo "  Knowledge Base Templates"
          echo "  CI/CD Workflow Templates"
          echo "  Investigation Templates"
          echo "  Multi-framework Support"
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "   Deployment Successful"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
