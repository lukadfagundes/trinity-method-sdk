# {{PROJECT_NAME}} - Trinity Method CI Pipeline
# Trinity Method v{{TRINITY_VERSION}}
# Framework: {{FRAMEWORK}}
# Generated by: EIN (CI/CD Specialist)

name: Trinity CI Pipeline

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  trinity-quality-gates:
    name: Trinity BAS 6-Phase Quality Gates
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      # Setup Node.js
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # =============================================
      # BAS PHASE 1: Linting (with auto-fix)
      # =============================================
      - name: 'BAS Phase 1: Linting'
        id: lint
        run: |
          echo "ğŸ” Running ESLint with auto-fix..."
          npm run lint -- --fix || npm run lint:fix || npx eslint . --fix || true
          echo "âœ… Linting phase complete"

      # =============================================
      # BAS PHASE 2: Structure Validation
      # =============================================
      - name: 'BAS Phase 2: Structure Validation'
        id: structure
        run: |
          echo "ğŸ” Validating project structure..."

          # Check required directories exist
          dirs=("src" "tests" "trinity" ".claude")
          for dir in "${dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "âŒ Required directory missing: $dir"
              exit 1
            fi
          done

          # Check package.json has required scripts
          if ! grep -q '"test"' package.json; then
            echo "âŒ package.json missing 'test' script"
            exit 1
          fi

          echo "âœ… Structure validation complete"

      # =============================================
      # BAS PHASE 3: Build Validation
      # =============================================
      - name: 'BAS Phase 3: Build Validation'
        id: build
        run: |
          echo "ğŸ”¨ Building project..."
          npm run build
          echo "âœ… Build validation complete"

      # =============================================
      # BAS PHASE 4: Testing (All Tests Pass)
      # =============================================
      - name: 'BAS Phase 4: Testing'
        id: tests
        run: |
          echo "ğŸ§ª Running all tests..."
          npm test
          echo "âœ… All tests passed"

      # =============================================
      # BAS PHASE 5: Coverage Check (â‰¥80%)
      # =============================================
      - name: 'BAS Phase 5: Coverage Check'
        id: coverage
        run: |
          echo "ğŸ“Š Checking test coverage..."
          npm test -- --coverage

          # Check coverage threshold
          echo "Validating coverage meets 80% threshold..."

          # Extract coverage percentage (adjust based on your coverage tool)
          # This example works with Jest coverage output
          if [ -f "coverage/coverage-summary.json" ]; then
            coverage=$(node -e "const c = require('./coverage/coverage-summary.json'); console.log(c.total.lines.pct);")
            threshold=80

            if (( $(echo "$coverage < $threshold" | bc -l) )); then
              echo "âŒ Coverage $coverage% is below threshold $threshold%"
              exit 1
            fi

            echo "âœ… Coverage $coverage% meets threshold $threshold%"
          else
            echo "âš ï¸  coverage-summary.json not found, skipping threshold check"
          fi

          echo "âœ… Coverage validation complete"

      # =============================================
      # BAS PHASE 6: Best Practices Validation
      # =============================================
      - name: 'BAS Phase 6: Best Practices'
        id: practices
        run: |
          echo "ğŸ“‹ Validating best practices..."

          # Check for common issues
          issues=0

          # Check: No console.log in production code (allow in tests)
          if grep -r "console\.log" src/ --exclude-dir=__tests__ 2>/dev/null | grep -v "//.*console\.log"; then
            echo "âš ï¸  Found console.log in production code"
            issues=$((issues+1))
          fi

          # Check: No TODO comments without issue references
          if grep -r "TODO" src/ 2>/dev/null | grep -v "TODO(#" | grep -v "//.*TODO:.*#"; then
            echo "âš ï¸  Found TODO without issue reference"
            issues=$((issues+1))
          fi

          # Check: TypeScript strict mode enabled
          if [ -f "tsconfig.json" ]; then
            if ! grep -q '"strict": true' tsconfig.json; then
              echo "âš ï¸  TypeScript strict mode not enabled"
              issues=$((issues+1))
            fi
          fi

          if [ $issues -gt 0 ]; then
            echo "âš ï¸  Found $issues best practice issues (warnings only)"
          fi

          echo "âœ… Best practices validation complete"

      # =============================================
      # Coverage Upload (Optional - Codecov)
      # =============================================
      - name: Upload coverage to Codecov
        if: success()
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false  # Don't fail CI if Codecov upload fails

      # =============================================
      # Trinity Quality Summary
      # =============================================
      - name: Trinity Quality Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "   Trinity BAS 6-Phase Quality Gates"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Phase 1: Linting            - ${{ steps.lint.outcome }}"
          echo "Phase 2: Structure          - ${{ steps.structure.outcome }}"
          echo "Phase 3: Build              - ${{ steps.build.outcome }}"
          echo "Phase 4: Tests              - ${{ steps.tests.outcome }}"
          echo "Phase 5: Coverage (â‰¥80%)    - ${{ steps.coverage.outcome }}"
          echo "Phase 6: Best Practices     - ${{ steps.practices.outcome }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
